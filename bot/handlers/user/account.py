
from aiogram import F, Router
from aiogram.exceptions import TelegramAPIError
from aiogram.types import CallbackQuery
from sqlalchemy.ext.asyncio import AsyncSession

from bot.utils.view import render_view
from bot.handlers.start import get_common_image
from bot.keyboards.inline.start_user import get_account_center_keyboard
from bot.utils.permissions import _resolve_role, require_user_feature

router = Router(name="user_account")


@router.callback_query(F.data == "user:account")
async def show_account_center(callback: CallbackQuery, session: AsyncSession) -> None:
    """å±•ç¤ºè´¦å·ä¸­å¿ƒ

    åŠŸèƒ½è¯´æ˜:
    - å±•ç¤ºäºŒçº§è´¦å·ä¸­å¿ƒèœå•, åº•éƒ¨åŒ…å«è¿”å›ä¸»é¢æ¿

    è¾“å…¥å‚æ•°:
    - callback: å›è°ƒå¯¹è±¡
    - session: å¼‚æ­¥æ•°æ®åº“ä¼šè¯

    è¿”å›å€¼:
    - None
    """
    has_emby_account = True
    kb = get_account_center_keyboard(has_emby_account)
    msg = callback.message
    if msg:
        uid = callback.from_user.id if callback.from_user else None
        await _resolve_role(session, uid)
        image = get_common_image()
        await render_view(msg, image, "ğŸ§¾ è´¦å·ä¸­å¿ƒ", kb)
    await callback.answer()


@router.callback_query(F.data == "user:register")
@require_user_feature("user.register")
async def user_register(callback: CallbackQuery, session: AsyncSession) -> None:
    """å¼€å§‹æ³¨å†Œ

    åŠŸèƒ½è¯´æ˜:
    - è¿›å…¥æ³¨å†Œæµç¨‹å…¥å£, å½“å‰ä¸ºå ä½å®ç°

    è¾“å…¥å‚æ•°:
    - callback: å›è°ƒå¯¹è±¡
    - session: å¼‚æ­¥æ•°æ®åº“ä¼šè¯

    è¿”å›å€¼:
    - None
    """
    if session is None:
        pass
    try:
        await callback.answer("åŠŸèƒ½å»ºè®¾ä¸­, è¯·ç¨åå†è¯•", show_alert=True)
    except TelegramAPIError:
        await callback.answer("ğŸ”´ ç³»ç»Ÿå¼‚å¸¸, è¯·ç¨åå†è¯•", show_alert=True)


@router.callback_query(F.data == "user:info")
@require_user_feature("user.info")
async def user_info(callback: CallbackQuery, session: AsyncSession) -> None:
    """è´¦å·ä¿¡æ¯

    åŠŸèƒ½è¯´æ˜:
    - å±•ç¤ºè´¦å·ä¿¡æ¯å…¥å£, å½“å‰ä¸ºå ä½å®ç°

    è¾“å…¥å‚æ•°:
    - callback: å›è°ƒå¯¹è±¡
    - session: å¼‚æ­¥æ•°æ®åº“ä¼šè¯

    è¿”å›å€¼:
    - None
    """
    if session is None:
        pass
    try:
        await callback.answer("åŠŸèƒ½å»ºè®¾ä¸­, è¯·ç¨åå†è¯•", show_alert=True)
    except TelegramAPIError:
        await callback.answer("ğŸ”´ ç³»ç»Ÿå¼‚å¸¸, è¯·ç¨åå†è¯•", show_alert=True)


@router.callback_query(F.data == "user:lines")
@require_user_feature("user.lines")
async def user_lines(callback: CallbackQuery, session: AsyncSession) -> None:
    """çº¿è·¯ä¿¡æ¯

    åŠŸèƒ½è¯´æ˜:
    - å±•ç¤ºçº¿è·¯ä¿¡æ¯å…¥å£, å½“å‰ä¸ºå ä½å®ç°

    è¾“å…¥å‚æ•°:
    - callback: å›è°ƒå¯¹è±¡
    - session: å¼‚æ­¥æ•°æ®åº“ä¼šè¯

    è¿”å›å€¼:
    - None
    """
    if session is None:
        pass
    try:
        await callback.answer("åŠŸèƒ½å»ºè®¾ä¸­, è¯·ç¨åå†è¯•", show_alert=True)
    except TelegramAPIError:
        await callback.answer("ğŸ”´ ç³»ç»Ÿå¼‚å¸¸, è¯·ç¨åå†è¯•", show_alert=True)


@router.callback_query(F.data == "user:devices")
@require_user_feature("user.devices")
async def user_devices(callback: CallbackQuery, session: AsyncSession) -> None:
    """è®¾å¤‡ç®¡ç†

    åŠŸèƒ½è¯´æ˜:
    - è¿›å…¥è®¾å¤‡ç®¡ç†å…¥å£, å½“å‰ä¸ºå ä½å®ç°

    è¾“å…¥å‚æ•°:
    - callback: å›è°ƒå¯¹è±¡
    - session: å¼‚æ­¥æ•°æ®åº“ä¼šè¯

    è¿”å›å€¼:
    - None
    """
    if session is None:
        pass
    try:
        await callback.answer("åŠŸèƒ½å»ºè®¾ä¸­, è¯·ç¨åå†è¯•", show_alert=True)
    except TelegramAPIError:
        await callback.answer("ğŸ”´ ç³»ç»Ÿå¼‚å¸¸, è¯·ç¨åå†è¯•", show_alert=True)


@router.callback_query(F.data == "user:password")
@require_user_feature("user.password")
async def user_password(callback: CallbackQuery, session: AsyncSession) -> None:
    """ä¿®æ”¹å¯†ç 

    åŠŸèƒ½è¯´æ˜:
    - è¿›å…¥ä¿®æ”¹å¯†ç å…¥å£, å½“å‰ä¸ºå ä½å®ç°

    è¾“å…¥å‚æ•°:
    - callback: å›è°ƒå¯¹è±¡
    - session: å¼‚æ­¥æ•°æ®åº“ä¼šè¯

    è¿”å›å€¼:
    - None
    """
    if session is None:
        pass
    try:
        await callback.answer("åŠŸèƒ½å»ºè®¾ä¸­, è¯·ç¨åå†è¯•", show_alert=True)
    except TelegramAPIError:
        await callback.answer("ğŸ”´ ç³»ç»Ÿå¼‚å¸¸, è¯·ç¨åå†è¯•", show_alert=True)


@router.callback_query(F.data == "user:profile")
async def user_profile(callback: CallbackQuery, session: AsyncSession) -> None:
    """ä¸ªäººä¿¡æ¯

    åŠŸèƒ½è¯´æ˜:
    - å±•ç¤ºä¸ªäººä¿¡æ¯å…¥å£, å½“å‰ä¸ºå ä½å®ç°

    è¾“å…¥å‚æ•°:
    - callback: å›è°ƒå¯¹è±¡
    - session: å¼‚æ­¥æ•°æ®åº“ä¼šè¯

    è¿”å›å€¼:
    - None
    """
    if session is None:
        pass
    try:
        await callback.answer("åŠŸèƒ½å»ºè®¾ä¸­, è¯·ç¨åå†è¯•", show_alert=True)
    except TelegramAPIError:
        await callback.answer("âŒ ç³»ç»Ÿå¼‚å¸¸, è¯·ç¨åå†è¯•", show_alert=True)
