## 目标
- 提升代码可维护性、稳定性与可观测性，保持现有功能与运行模式（轮询 + 内存FSM）。
- 优化统一启动体验、中文化日志、配置安全与错误处理，完善测试与CI。

## 架构与代码组织
- Handlers 分包与解耦：
  - 将群相关与管理员相关处理器拆分到 `bot/handlers/group/`、`bot/handlers/admin/`，每个文件职能单一（如：配置、消息保存、导出）。
  - 聚合入口继续使用 `get_handlers_router()` `bot/handlers/__init__.py:14-34`。
- Services 与 Repository：
  - 在 `bot/services/` 引入清晰的服务层接口，将数据库访问通过 repository 封装，减少处理器内的 SQLAlchemy 直接调用。
- 类型与注释：
  - 所有函数补足函数级注释（功能说明、输入参数、返回值），统一 snake_case；补强 `mypy` 类型覆盖率。

## 启动与运维体验
- 统一启动脚本 `run_api.py`：
  - 表格列宽严格固定（居中列名、边框字符）与“网络地址”常态展示；展示版本号与路由数量摘要（来自 `bot/api_server/app`）。
  - 统一中文摘要输出，保留耗时统计与健康探测 `/health`。
- 入口 `bot/__main__.py`：
  - 仅输出中文的“启动中/完成/停止中/已停止”，避免与统一启动脚本重复。

## 配置与安全
- 配置校验：
  - 在 `bot/core/config.py` 的 `Settings._validate_settings` 增加交叉校验（DB_* 合规、BOT_TOKEN 格式、必填项提示）。
- 环境变量：
  - `.env/.env.example` 分组与中文注释已简化；增加 `DB_ECHO`（已挂载到引擎）。
  - 建议增加 `API_HOST`、`API_PORT` 映射到 FastAPI 配置（当前 `bot/api_server/config.py:24-51`）。
- 秘密与日志：
  - 在日志中进行脱敏（现有 `mask_database_url()`），禁止在日志输出令牌/密码；核心错误日志聚合到单个文件 `logs/telegram_bot.log`。

## 日志与可观测性
- 统一日志级别：
  - SQLAlchemy 降噪到 `WARNING`（现已完成）；Sentry 可选开启 `settings.SENTRY_DSN` `bot/__main__.py:99-110`。
- 结构化日志：
  - 推荐为 API 使用结构化日志（JSON），便于后续统一采集（保留中文 message）。

## 错误处理与中间件
- 中间件注册顺序核对：日志 → 限流 → 数据库 → 鉴权，集中于 `bot/middlewares/__init__.py:10-19`。
- 错误处理：
  - 在处理器与服务层增加 `try/except`，针对数据库异常进行回滚与友好提示；在统一启动脚本中对 API 端口占用进行自动避让（已完成）。

## 数据库与迁移
- 模型与索引：
  - 检查 `bot/database/models/*` 索引与唯一约束是否覆盖热点查询；为消息导出等增加必要索引（结合查询路径）。
- 迁移与回滚：
  - 保持 Alembic 迁移脚本规范，提供回滚脚本；在 CI 中加入迁移干跑（`alembic upgrade head --sql`）。

## 业务与处理器优化
- 大文件拆分：
  - 如 `bot/handlers/group_message_saver.py:33,459,490`、`message_export.py:31,41,84,166...`，拆分为多个路由文件（保存、配置、导出）。
- 频率限制与 FloodWait：
  - 在限流中间件增强对 Telegram 的速率限制提示，避免触发 FloodWait。

## Telegram API 合规
- 消息长度限制：
  - 输出内容控制在 4096 字符以内；图片/文档发送注意调用频率与并发控制。
- 管理员校验：
  - `AuthMiddleware` 中明确管理员鉴权逻辑与错误提示 `bot/middlewares/auth.py`。

## 测试与质量保障
- 单元测试：
  - 为 `services` 与 `handlers` 关键路径添加测试；为数据库操作编写异步测试（使用临时 MySQL 或 SQLite/aiosqlite）。
- 端到端测试：
  - 保留 `bot/tests/`；引入 Chat 交互的集成测试脚本（DEBUG 环境路由接入 `bot/handlers/__init__.py:29-33`）。
- 静态检查：
  - 现有 `ruff`/`mypy` 配置已存在 `pyproject.toml:73-115`；提高类型覆盖率、消除忽略项。

## API 与前端
- API：
  - 标准化响应模型（Pydantic），统一错误码与中文错误信息；覆盖 CORS 与鉴权（如 token 或 admin 校验）。
  - 增加统计与监控路由（如 `/metrics` 可选，当前项目移除 Prometheus）。
- 前端（web）：
  - 在统一启动脚本中解析并展示 Local/Network 地址（已支持），可增加前端健康探测（访问静态资源或根路由）。

## 性能与可靠性
- 连接池与重试：
  - 数据库连接池参数在 `bot/core/config.py` 已设置；对关键查询增加超时与重试机制。
- 并发与背压：
  - 在高并发情况下控制同时进行的 I/O 操作数量，避免阻塞。

## 文档与开发者体验
- 中文化运行指南：
  - 在 README 中补充“Windows 启动步骤、依赖安装、统一启动脚本说明、常见问题（端口占用、健康检查失败）”。
- 提交规范：
  - 遵循“Add/Fix/Update/Refactor”开头，标题简洁、正文说明变更与影响。

## 里程碑（不改变外部行为）
- 阶段1：结构与启动（1-2天）
  - Handlers 拆分与聚合改造；统一启动脚本视觉与信息优化；入口中文日志精简。
- 阶段2：配置与错误处理（1天）
  - Settings 校验增强；服务层与处理器错误处理与限流提示完善。
- 阶段3：测试与质量（2-3天）
  - 单元与集成测试补充；CI 增加迁移干跑与测试执行。
- 阶段4：数据库与性能（2天）
  - 索引与查询优化；连接池与重试机制评估与落地。

## 风险与回滚
- 拆分处理器：仅改导入路径与注册，不改逻辑；出现问题可快速回滚到原文件。
- 统一启动脚本：保留原有机器人入口不动；变更只影响摘要输出，可随时还原。

## 验证方式
- `python run_api.py` 启动所有服务，观察中文服务清单与健康状态。
- 在 DEBUG 环境触发主要命令，验证路由与处理器工作正常；观察日志文件与数据库连接行为。

确认后，我将按阶段逐项实施（先结构与启动，再配置与错误处理、测试与质量、数据库与性能），每一步完成后提供中文摘要与影响范围说明，并保持最小侵入式改动。