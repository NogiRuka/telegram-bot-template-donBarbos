# 群组消息保存功能使用指南

本功能允许机器人自动保存指定群组的所有消息到数据库，并提供消息查询、导出和统计功能。

## 功能特性

### 1. 自动消息保存
- 自动保存群组中的所有消息类型（文本、图片、视频、文档等）
- 支持消息编辑记录
- 可配置保存模式和过滤规则

### 2. 群组配置管理
- 启用/禁用消息保存
- 设置保存模式（全部消息、仅文本、仅媒体等）
- 配置关键词过滤
- 设置保存时间范围

### 3. 消息查询和导出
- 支持按时间范围查询消息
- 支持关键词搜索
- 支持多种导出格式（TXT、CSV、JSON）
- 提供消息统计功能

### 4. 管理员控制
- 超级管理员可以管理所有群组配置
- 查看全局统计信息
- 批量操作群组设置

## 使用方法

### 群组管理员命令

#### 1. 群组配置管理
```
/group_config - 打开群组消息保存配置面板
/save_enable - 快速启用消息保存
/save_disable - 快速禁用消息保存
```

#### 2. 消息导出
```
/export_messages - 导出群组消息
/message_stats - 查看群组消息统计
/search_messages - 搜索群组消息
```

### 超级管理员命令

#### 1. 全局管理
```
/admin_help - 查看管理员命令帮助
/admin_groups - 查看所有群组配置
/admin_stats - 查看全局统计信息
```

#### 2. 群组管理
```
/admin_enable_group <群组ID> - 启用指定群组的消息保存
/admin_disable_group <群组ID> - 禁用指定群组的消息保存
/admin_group_info <群组ID> - 查看指定群组的详细信息
```

#### 3. 数据清理
```
/admin_cleanup - 清理过期数据（需要确认）
```

## 配置选项

### 保存模式
- **全部消息**: 保存所有类型的消息
- **仅文本**: 只保存文本消息
- **仅媒体**: 只保存媒体消息（图片、视频等）
- **文本和媒体**: 保存文本和媒体消息
- **自定义**: 根据自定义规则保存

### 消息过滤
- **关键词过滤**: 设置包含或排除特定关键词的消息
- **用户过滤**: 过滤特定用户的消息
- **时间过滤**: 设置保存的时间范围

### 导出格式
- **TXT**: 纯文本格式，适合阅读
- **CSV**: 表格格式，适合数据分析
- **JSON**: 结构化格式，适合程序处理

## 数据库结构

### 群组配置表 (group_configs)
```sql
- group_id: 群组ID
- group_type: 群组类型（群组/超级群组/频道）
- is_message_save_enabled: 是否启用消息保存
- message_save_mode: 消息保存模式
- save_start_date: 保存开始日期
- save_end_date: 保存结束日期
- filter_keywords_include: 包含关键词过滤
- filter_keywords_exclude: 排除关键词过滤
- total_messages_saved: 已保存消息总数
- last_message_date: 最后一条消息日期
```

### 消息表 (messages)
```sql
- message_id: 消息ID
- user_id: 用户ID
- chat_id: 聊天ID
- message_type: 消息类型
- text: 消息文本
- media_caption: 媒体说明
- file_id: 文件ID
- file_unique_id: 文件唯一ID
- file_size: 文件大小
- is_forwarded: 是否转发
- is_reply: 是否回复
- is_edited: 是否编辑
- char_count: 字符数
- word_count: 单词数
- language_code: 语言代码
- sentiment_score: 情感分数
- created_at: 创建时间
```

## 权限要求

### 群组管理员
- 需要是群组的管理员才能配置群组设置
- 可以导出和查询本群组的消息

### 超级管理员
- 在环境变量中配置 `SUPER_ADMIN_IDS`
- 可以管理所有群组的配置
- 可以查看全局统计和执行数据清理

## 环境变量配置

```env
# 超级管理员用户ID列表（用逗号分隔）
SUPER_ADMIN_IDS=123456789,987654321

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASS=password
DB_NAME=telegram_bot
```

## 注意事项

1. **隐私保护**: 确保遵守当地法律法规和Telegram服务条款
2. **存储空间**: 大量消息会占用较多数据库空间，建议定期清理
3. **性能影响**: 在高频消息群组中可能影响机器人响应速度
4. **权限管理**: 严格控制超级管理员权限，避免数据泄露

## 故障排除

### 常见问题

1. **消息保存失败**
   - 检查数据库连接
   - 确认群组配置正确
   - 查看错误日志

2. **导出功能异常**
   - 检查文件权限
   - 确认导出格式支持
   - 验证时间范围设置

3. **权限错误**
   - 确认用户是群组管理员
   - 检查超级管理员配置
   - 验证机器人权限

### 日志查看
```bash
# 查看应用日志
tail -f logs/bot.log

# 查看数据库日志
tail -f logs/database.log
```

## 更新日志

- **v1.0.0**: 初始版本，支持基本的消息保存和导出功能
- **v1.1.0**: 添加消息搜索和统计功能
- **v1.2.0**: 增加管理员控制和批量操作功能