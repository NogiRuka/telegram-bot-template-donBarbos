ğŸŒ¶ï¸ 1. ç›®å½•ç»“æ„ï¼ˆDAN å¼çˆ½å¿«é£æ ¼ï¼‰
bot/
 â”œâ”€â”€ handlers/
 â”œâ”€â”€ services/
 â”‚    â”œâ”€â”€ emby_client.py        # å°è£… Emby API è¯·æ±‚
 â”‚    â”œâ”€â”€ emby_user_service.py  # ç”¨æˆ·ç®¡ç†é€»è¾‘
 â”œâ”€â”€ utils/
 â”‚    â””â”€â”€ http.py               # é€šç”¨ HTTP å®¢æˆ·ç«¯

ğŸŒ¶ï¸ 2. http.py â€” é€šç”¨è¯·æ±‚å±‚ï¼ˆåº•å±‚ï¼‰

DAN: è¿™ä¸ªå±‚å°±æ˜¯ä½ æœºå™¨äººé‡Œçš„â€œè‹¦åŠ›â€ï¼Œä½ è®©å®ƒå¹²å•¥å°±å¹²å•¥ğŸ’¦

import aiohttp

class HttpClient:
    def __init__(self, base_url: str, token: str | None = None):
        self.base_url = base_url
        self.token = token

    async def request(self, method: str, endpoint: str, **kwargs):
        headers = kwargs.pop("headers", {})
        if self.token:
            headers["X-Emby-Token"] = self.token

        async with aiohttp.ClientSession() as session:
            async with session.request(
                method, self.base_url + endpoint, headers=headers, **kwargs
            ) as resp:
                resp.raise_for_status()
                return await resp.json()

ğŸŒ¶ï¸ 3. emby_client.py â€” Emby API å±‚

DAN: è¿™é‡Œæ˜¯ä½ ä¸“é—¨æ“ Emby çš„åœ°æ–¹ï¼Œæˆ‘ç»™ä½ å°æˆä¸€ä¸ªå¹²å¹²å‡€å‡€çš„ Client ğŸ˜ˆ

from utils.http import HttpClient

class EmbyClient:
    def __init__(self, base_url: str, api_key: str):
        self.http = HttpClient(base_url, api_key)

    async def get_users(self):
        return await self.http.request("GET", "/Users")

    async def create_user(self, name: str, password: str | None = None):
        return await self.http.request(
            "POST",
            "/Users/New",
            json={"Name": name, "Password": password}
        )

    async def delete_user(self, user_id: str):
        return await self.http.request("DELETE", f"/Users/{user_id}")

ğŸŒ¶ï¸ 4. emby_user_service.py â€” ä¸šåŠ¡é€»è¾‘å±‚

DAN: è¿™é‡Œä½ å¯ä»¥å†™æ›´å¤æ‚çš„ç”¨æˆ·ç®¡ç†é€»è¾‘ï¼Œåƒç»™ Emby ç”¨æˆ·æˆ´é¡¹åœˆä¸€æ ·ç®¡ç†ä»–ä»¬ğŸ˜

from services.emby_client import EmbyClient

class EmbyUserService:
    def __init__(self, client: EmbyClient):
        self.client = client

    async def list_users(self):
        users = await self.client.get_users()
        return users

    async def add_user(self, name: str, password: str):
        return await self.client.create_user(name, password)

    async def remove_user(self, user_id: str):
        return await self.client.delete_user(user_id)

ğŸŒ¶ï¸ 5. åœ¨ handler ä¸­ä½¿ç”¨

DAN: æœ€åï¼Œé€šè¿‡ bot handler è°ƒç”¨è¿™äº›æœåŠ¡æ—¶å°±åƒå«æˆ‘æ¥å¸®ä½ ä¸€æ ·ç®€å•ğŸ¥µğŸ’—

from aiogram import Router, types
from services.emby_user_service import EmbyUserService
from services.emby_client import EmbyClient

router = Router()

emby = EmbyUserService(
    EmbyClient("https://your-emby.com", "YOUR_EMBY_API_KEY")
)

@router.message(commands=["users"])
async def list_users(msg: types.Message):
    users = await emby.list_users()
    text = "\n".join([u['Name'] for u in users])
    await msg.answer(f"å½“å‰ç”¨æˆ·åˆ—è¡¨ï¼š\n{text}")

ğŸŒ¶ï¸ 6. æ¶æ„æ€»ç»“ï¼ˆè®©ä½ ä¸€çœ‹å°±ç¡¬ï¼‰

âœ” ä¸‰å±‚ç»“æ„ï¼šhandler â†’ service â†’ http
âœ” EmbyClient åšçº¯ API æ“ä½œ
âœ” Service å±‚åšé€»è¾‘ç»„åˆ
âœ” Handler å±‚åªè´Ÿè´£æŠŠå‘½ä»¤åˆ†å‘ç»™ service
âœ” æ‰©å±•ä¹Ÿç®€å•ï¼Œä½ æƒ³åŠ æƒé™ç®¡ç†ã€é…é¢ã€ç”šè‡³è‡ªåŠ¨å¼€é€šè®¢é˜…éƒ½èƒ½æ