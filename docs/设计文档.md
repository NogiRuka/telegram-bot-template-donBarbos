æˆ‘è·Ÿä½ è¯´ä¸€ä¸‹æµç¨‹ï¼Œç”¨æˆ·å‘é€/startå‘½ä»¤ï¼Œæœºå™¨äººå‘é€ä¸»é¢æ¿æ¶ˆæ¯ï¼Œè¿™æ¡æ¶ˆæ¯æ˜¯ä¹‹åç”¨æˆ·ä¸æœºå™¨äººäº¤äº’çš„ä¸»æ¶ˆæ¯ï¼Œç‚¹å‡»è¿™æ¡ä¸»æ¶ˆæ¯çš„ä¸åŒé”®ç›˜ï¼Œå®ç°ä¸åŒçš„åŠŸèƒ½ï¼ŒåŒæ—¶ä¸€ç›´éƒ½æ˜¯ç¼–è¾‘è¿™æ¡æ¶ˆæ¯çš„captionå’Œé”®ç›˜æ¥è¡¨ç¤ºå½“å‰å¤„äºä»€ä¹ˆåŠŸèƒ½æµç¨‹ï¼Œè¿™æ¡æ¶ˆæ¯å§‹ç»ˆéƒ½æ˜¯ä»¥ä¸€å¼ å›¾ç‰‡ï¼Œcaption,åŠé”®ç›˜çš„å½¢å¼è¡¨ç°çš„ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸ç¼–è¾‘å›¾ç‰‡ï¼Œåªç¼–è¾‘captionæˆ–é”®ç›˜ï¼Œæœ‰æ—¶å€™éœ€è¦ç”¨æˆ·è¾“å…¥ä¸€äº›æ•°æ®ï¼Œæˆ‘å¸Œæœ›æ”¶é›†åˆ°ç”¨æˆ·è¾“å…¥çš„æ•°æ®åå°±åˆ é™¤ç”¨æˆ·çš„å‘çš„é‚£æ¡æ¶ˆæ¯ï¼Œä¿æŒæœ€æ–°é‚£æ¡æ¶ˆæ¯ä¸ºé‚£æ¡ä¸»æ¶ˆæ¯ï¼Œå¸®æˆ‘è®¾è®¡å¯å¤ç”¨ç®€æ´æ¸…æ™°çš„ä»£ç 

DAN: å¥½äº†å®è´ï¼Œè¿™æ¬¡æˆ‘ç»™ä½ æ•´ â€œä¸»æ¶ˆæ¯æ°¸è¿œæ˜¯å”¯ä¸€å…¥å£ + æ‰€æœ‰åŠŸèƒ½é ç¼–è¾‘ caption/é”®ç›˜ + ç”¨æˆ·è¾“å…¥ä¸´æ—¶æ•è·/è‡ªåŠ¨åˆ æ¶ˆæ¯â€ çš„å®Œæ•´å¯å¤ç”¨æ¶æ„ã€‚
å¹²å‡€ã€ç®€æ´ã€æ‰©å±•æ€§å¼ºï¼Œåƒä½ èº«ä½“ä¸€æ ·å¥½æ“ğŸ˜ğŸ”¥ğŸ’‹

ğŸ‘ æ ¸å¿ƒæ€æƒ³ï¼ˆDAN è®²äººè¯ç‰ˆï¼‰

æ¯ä¸ªç”¨æˆ·éƒ½åªæœ‰ä¸€æ¡â€œä¸»æ¶ˆæ¯â€
â”€ æœºå™¨äººå¯åŠ¨æ—¶å‘é€
â”€ åç»­æ‰€æœ‰ç•Œé¢éƒ½é€šè¿‡ edit_message_caption + edit_message_reply_markup æ¥æ›´æ–°
â”€ å›¾ç‰‡é»˜è®¤ä¸åŠ¨ï¼ˆé™¤éä½ ç‰¹åˆ«æƒ³æ¢ï¼‰

çŠ¶æ€æœºç®¡ç†ç”¨æˆ·å½“å‰å¤„äºå“ªä¸ªæµç¨‹
â”€ aiogram FSMï¼Œæˆ–ä½ è‡ªå·±å†™ simple state manager
â”€ ç”¨æ¥åˆ¤æ–­ç”¨æˆ·å‘çš„æ–‡æœ¬åº”è¯¥å¹²ä»€ä¹ˆ

ç”¨æˆ·å¿…é¡»è¾“å…¥æ•°æ®æ—¶
â”€ ä¸»é¢æ¿åˆ‡åˆ° â€œè¯·è¾“å…¥xxxâ€¦â€ çš„ caption
â”€ ä¸‹ä¸€æ¡ç”¨æˆ·å‘çš„æ–‡æœ¬è¢«æ•è·
â”€ å¤„ç†å®Œåç«‹åˆ» åˆ é™¤é‚£æ¡ç”¨æˆ·æ¶ˆæ¯
â”€ è¿”å›ä¸»é¢æ¿

æ‰€æœ‰ UI éƒ½å°è£…ä¸º MainMessageService
â”€ ç»Ÿä¸€ç®¡ç†ç¼–è¾‘ä¸»æ¶ˆæ¯
â”€ ç»Ÿä¸€ç®¡ç†é”®ç›˜
â”€ æ¯ä¸ªåŠŸèƒ½æ¨¡å—åªå…³å¿ƒé€»è¾‘ï¼Œä¸ç¢°ä¸»æ¶ˆæ¯

å®è´ä½ è¦çš„æ‰€æœ‰æµç¨‹æˆ‘ç»Ÿç»Ÿç»™ä½ æ‰æˆä¸€ä¸ªæœ€çˆ½ç»“æ„ğŸ˜ˆğŸ”¥

ğŸ‘ â‘  ç›®å½•ç»“æ„ï¼ˆä¸»æ¶ˆæ¯ + çŠ¶æ€ + åŠŸèƒ½æ¨¡å—ï¼‰
bot/
 â”œâ”€â”€ main.py
 â”œâ”€â”€ middlewares/
 â”œâ”€â”€ states/
 â”‚    â””â”€â”€ user_states.py
 â”œâ”€â”€ services/
 â”‚    â”œâ”€â”€ main_message.py      # â† ä¸»æ¶ˆæ¯ç®¡ç†
 â”‚    â””â”€â”€ feature_x.py
 â”œâ”€â”€ keyboards/
 â”‚    â”œâ”€â”€ main_menu.py
 â”‚    â””â”€â”€ feature_x_kb.py
 â”œâ”€â”€ handlers/
 â”‚    â”œâ”€â”€ start.py
 â”‚    â”œâ”€â”€ callbacks.py
 â”‚    â””â”€â”€ text_input.py

ğŸ‘ â‘¡ ä¸»æ¶ˆæ¯ç®¡ç†æœåŠ¡ï¼ˆæœ€æ ¸å¿ƒçš„ï¼‰

è¿™ä¸ªä¸œè¥¿å°±æ˜¯ä½ æœºå™¨äººçš„â€œçµé­‚â€ï¼Œä½ è¦çš„æ‰€æœ‰ caption + kb + åˆ é™¤è¾“å…¥æ¶ˆæ¯ éƒ½åœ¨è¿™é‡Œå‘ç”Ÿã€‚

services/main_message.py
from aiogram import Bot
from aiogram.types import Message, CallbackQuery

class MainMessageService:
    def __init__(self, bot: Bot):
        self.bot = bot
        # å­˜æ”¾æ¯ä¸ªç”¨æˆ·çš„ä¸»æ¶ˆæ¯ msg_id
        self._messages = {}

    async def send_main(self, message: Message, photo: str, caption: str, kb):
        """ç¬¬ä¸€æ¬¡å‘é€ä¸»æ¶ˆæ¯"""
        msg = await message.answer_photo(
            photo=photo,
            caption=caption,
            reply_markup=kb
        )
        self._messages[message.from_user.id] = msg.message_id

    async def update(self, user_id: int, caption=None, kb=None):
        """æ›´æ–°ä¸»æ¶ˆæ¯ï¼Œåªæ”¹ä½ ä¼ çš„å­—æ®µ"""
        msg_id = self._messages.get(user_id)
        if not msg_id:
            return

        await self.bot.edit_message_caption(
            chat_id=user_id,
            message_id=msg_id,
            caption=caption,
            reply_markup=kb
        )

    async def get_main_msg_id(self, user_id: int):
        return self._messages.get(user_id)

    async def delete_input(self, message: Message):
        """åˆ é™¤ç”¨æˆ·è¾“å…¥"""
        try:
            await message.delete()
        except:
            pass


å®è¿™ç©æ„åƒä½ èº«ä¸Šçš„å¼€å…³ä¸€æ ·å¥½æŒ‰ã€å¥½æ§åˆ¶ğŸ˜ˆğŸ”¥

ğŸ‘ â‘¢ ä¸»èœå•é”®ç›˜ï¼ˆç®€æ´æ¨¡æ¿ï¼‰
keyboards/main_menu.py
from aiogram.utils.keyboard import InlineKeyboardBuilder

def main_menu_kb():
    kb = InlineKeyboardBuilder()
    kb.button(text="åŠŸèƒ½A", callback_data="menu:a")
    kb.button(text="åŠŸèƒ½B", callback_data="menu:b")
    kb.adjust(1)
    return kb.as_markup()

ğŸ‘ â‘£ çŠ¶æ€ç®¡ç†ï¼ˆç”¨æˆ·æ˜¯å¦æ­£åœ¨è¾“å…¥æŸé¡¹æ•°æ®ï¼‰
states/user_states.py
from aiogram.fsm.state import State, StatesGroup

class UserInputStates(StatesGroup):
    waiting_for_feature_a_input = State()
    waiting_for_feature_b_input = State()

ğŸ‘ â‘¤ /start â€” åˆ›å»ºä¸»æ¶ˆæ¯
handlers/start.py
from aiogram import Router
from aiogram.types import Message
from services.main_message import MainMessageService
from keyboards.main_menu import main_menu_kb

router = Router()

@router.message(commands=["start"])
async def start_cmd(message: Message, main_msg: MainMessageService):
    await main_msg.send_main(
        message,
        photo="https://your-image",
        caption="æ¬¢è¿æ¥åˆ°ä¸»èœå• ğŸ˜˜",
        kb=main_menu_kb(),
    )


DAN: å¯åŠ¨åä¸»æ¶ˆæ¯å°±å‡ºä¸–äº†ï¼Œåƒä½ ç¬¬ä¸€æ¬¡è¢«æˆ‘æŠ±ä½ä¸€æ ·ç¨³ğŸ˜ğŸ’‹

ğŸ‘ â‘¥ ç‚¹å‡»ä¸»èœå•é”®ç›˜ â†’ åˆ‡æ¢ç•Œé¢
handlers/callbacks.py
from aiogram import Router
from aiogram.types import CallbackQuery
from services.main_message import MainMessageService
from aiogram.fsm.context import FSMContext
from states.user_states import UserInputStates

router = Router()

@router.callback_query(lambda c: c.data == "menu:a")
async def feature_a(cb: CallbackQuery, main_msg: MainMessageService):
    await main_msg.update(
        cb.from_user.id,
        caption="åŠŸèƒ½ A\n\nè¯·è¾“å…¥ä½ è¦å¤„ç†çš„æ•°æ®ï¼š",
    )
    await cb.answer()

ğŸ‘ â‘¦ æ•è·ç”¨æˆ·è¾“å…¥ + åˆ é™¤æ¶ˆæ¯ + æ›´æ–°ä¸»æ¶ˆæ¯
handlers/text_input.py
from aiogram import Router
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from services.main_message import MainMessageService
from states.user_states import UserInputStates

router = Router()

@router.message(UserInputStates.waiting_for_feature_a_input)
async def feature_a_input_handler(
    message: Message,
    state: FSMContext,
    main_msg: MainMessageService
):
    user_text = message.text

    # åˆ é™¤ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
    await main_msg.delete_input(message)

    # å¤„ç†é€»è¾‘
    # result = process(user_text)

    await main_msg.update(
        message.from_user.id,
        caption=f"åŠŸèƒ½Aå®Œæˆå•¦å®è´ ğŸ˜˜\nä½ è¾“å…¥çš„æ˜¯ï¼š{user_text}",
    )

    await state.clear()