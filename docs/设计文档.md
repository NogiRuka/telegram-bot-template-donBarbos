ä¸‹é¢æˆ‘ç»™ä½ ä¸€ä¸ªæ¸…æ™°ã€ä¸è¿‡åº¦è®¾è®¡ã€å®Œå…¨è´´åˆä½ ç°æœ‰é€»è¾‘çš„ Service æ‹†åˆ†æ–¹æ¡ˆï¼Œä½ å¯ä»¥ä¸€æ­¥æ­¥è¿ç§»ï¼Œä¸éœ€è¦æ¨ç¿»é‡æ¥ã€‚

ğŸ¯ ç›®æ ‡

æŠŠç°åœ¨ handler é‡Œæ··åœ¨ä¸€èµ·çš„é€»è¾‘æ‹†æˆï¼š

Router / Handlerï¼šåªç®¡ Telegram äº¤äº’

Serviceï¼šåªç®¡ä¸šåŠ¡ï¼ˆé€šçŸ¥ã€å»é‡ã€çŠ¶æ€æµè½¬ï¼‰

Repositoryï¼ˆå¯é€‰ï¼‰ï¼šåªç®¡æ•°æ®åº“æŸ¥è¯¢ï¼ˆå¦‚æœä½ æƒ³å†å¹²å‡€ä¸€ç‚¹ï¼‰

ğŸ§  æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼ˆå¾ˆé‡è¦ï¼‰

Notification æ˜¯çŠ¶æ€è¡¨ï¼Œä¸æ˜¯ä¸šåŠ¡å®ä½“

ä¸šåŠ¡å®ä½“ = business_keyï¼ˆSeries / Movie / Episode â†’ Seriesï¼‰

æ‰€æœ‰å»é‡ã€ç»Ÿè®¡ã€å‘é€éƒ½å›´ç»• business_key

ğŸ§© ä¸€ã€æŠ½ç¦»ã€Œä¸šåŠ¡ keyã€å·¥å…·ï¼ˆæœ€åº•å±‚ï¼‰

ğŸ“ bot/services/notification/utils.py

from sqlalchemy import case
from bot.database.models.notification import NotificationModel

def business_key():
    """
    Episode -> series_id
    å…¶ä»– -> item_id
    """
    return case(
        (
            (NotificationModel.item_type == "Episode")
            & (NotificationModel.series_id.isnot(None)),
            NotificationModel.series_id,
        ),
        else_=NotificationModel.item_id,
    )


âœ… æ‰€æœ‰åœ°æ–¹ åª import è¿™ä¸ªå‡½æ•°
âŒ ä¸å…è®¸åœ¨ handler/service é‡Œè‡ªå·±å†™ case

ğŸ§© äºŒã€NotificationQueryServiceï¼ˆæŸ¥æ•°æ®ï¼‰

ğŸ“ bot/services/notification/query.py

from sqlalchemy import select, func
from bot.database.models.notification import NotificationModel
from bot.database.models.emby_item import EmbyItemModel
from .utils import business_key
from bot.core.constants import (
    EVENT_TYPE_LIBRARY_NEW,
    NOTIFICATION_STATUS_PENDING_REVIEW,
)

class NotificationQueryService:

    @staticmethod
    def preview_subquery():
        bk = business_key()
        return (
            select(
                func.min(NotificationModel.id).label("notif_id"),
                bk.label("biz_id"),
            )
            .where(
                NotificationModel.status == NOTIFICATION_STATUS_PENDING_REVIEW,
                NotificationModel.type == EVENT_TYPE_LIBRARY_NEW,
            )
            .group_by(bk)
            .subquery()
        )

    @staticmethod
    async def get_preview_rows(session):
        subq = NotificationQueryService.preview_subquery()
        bk = business_key()

        stmt = (
            select(NotificationModel, EmbyItemModel)
            .join(subq, NotificationModel.id == subq.c.notif_id)
            .join(EmbyItemModel, EmbyItemModel.id == subq.c.biz_id)
        )

        result = await session.execute(stmt)
        return result.all()

    @staticmethod
    async def count_by_status(session, statuses: list[str]):
        bk = business_key()
        stmt = (
            select(
                NotificationModel.status,
                func.count(func.distinct(bk)).label("cnt"),
            )
            .where(
                NotificationModel.type == EVENT_TYPE_LIBRARY_NEW,
                NotificationModel.status.in_(statuses),
            )
            .group_by(NotificationModel.status)
        )
        rows = await session.execute(stmt)
        return {row.status: row.cnt for row in rows}

ğŸ§© ä¸‰ã€NotificationActionServiceï¼ˆæ”¹çŠ¶æ€ï¼‰

ğŸ“ bot/services/notification/action.py

from sqlalchemy import select, update
from bot.database.models.notification import NotificationModel
from .utils import business_key

class NotificationActionService:

    @staticmethod
    async def reject_by_notification_id(session, notif_id: int, new_status: str):
        bk = business_key()

        biz_id_sq = (
            select(bk)
            .where(NotificationModel.id == notif_id)
            .scalar_subquery()
        )

        await session.execute(
            update(NotificationModel)
            .where(bk == biz_id_sq)
            .values(status=new_status)
        )
        await session.commit()

    @staticmethod
    async def mark_group_sent(
        session,
        biz_id: int,
        target_channels: list[int],
        success: bool,
        sent_status: str,
        failed_status: str,
    ):
        await session.execute(
            update(NotificationModel)
            .where(business_key() == biz_id)
            .values(
                status=sent_status if success else failed_status,
                target_channel_id=",".join(map(str, target_channels))
                if success else None,
            )
        )

ğŸ§© å››ã€NotificationSendServiceï¼ˆçœŸæ­£â€œå‘â€ï¼‰

ğŸ“ bot/services/notification/send.py

from bot.services.notification.query import NotificationQueryService
from bot.services.notification.action import NotificationActionService
from bot.utils.notification import get_notification_content

class NotificationSendService:

    @staticmethod
    async def send_all(session, bot, target_chat_ids: list[int]):
        rows = await NotificationQueryService.get_preview_rows(session)

        sent = failed = 0

        for notif, item in rows:
            text, image = get_notification_content(item)
            ok = False

            for chat_id in target_chat_ids:
                try:
                    if image:
                        await bot.send_photo(chat_id, image, caption=text)
                    else:
                        await bot.send_message(chat_id, text)
                    ok = True
                except Exception:
                    pass

            await NotificationActionService.mark_group_sent(
                session=session,
                biz_id=item.id,
                target_channels=target_chat_ids,
                success=ok,
                sent_status="sent",
                failed_status="failed",
            )

            sent += ok
            failed += not ok

        await session.commit()
        return sent, failed

ğŸ§© äº”ã€Handler ç°åœ¨ä¼šå˜æˆè¿™æ ·ï¼ˆéå¸¸å¹²å‡€ï¼‰
@router.callback_query(F.data == "admin:notify_preview")
async def handle_notify_preview(
    callback: types.CallbackQuery,
    session: AsyncSession,
    state: FSMContext,
):
    rows = await NotificationQueryService.get_preview_rows(session)

    if not rows:
        await callback.answer("ğŸˆš æ²¡æœ‰å¯é¢„è§ˆçš„é€šçŸ¥")
        return

    await callback.answer(f"ğŸ‘€ æ­£åœ¨ç”Ÿæˆ {len(rows)} æ¡é¢„è§ˆâ€¦")

    preview_data = {}

    for notif, item in rows:
        text, image = get_notification_content(item)
        # æ„å»ºé”®ç›˜ã€å‘é€æ¶ˆæ¯ï¼ˆUI é€»è¾‘ç•™åœ¨ handlerï¼‰
        ...

âœ… æ‹†å®Œä¹‹åä½ ä¼šå¾—åˆ°ä»€ä¹ˆï¼Ÿ

âœ” ä»»ä½•ä¸€ä¸ª handler ä¸å†ç¢° SQL
âœ” preview / send / count ç»“æœæ°¸è¿œä¸€è‡´