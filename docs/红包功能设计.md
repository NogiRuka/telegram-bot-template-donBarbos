# 红包功能设计文档（草案）

## 1. 功能目标与边界

### 1.1 功能目标

- 支持在群聊中发红包、抢红包。
- 红包基于站内虚拟货币 / 积分系统（不接入真实支付渠道）。
- 支持固定金额红包与拼手气红包。
- 支持红包状态追踪（进行中 / 已领完 / 已过期 / 已撤销）。
- 支持红包过期退款给发起人。
- 设计上为后续扩展预留口令红包、指定对象红包等能力。

### 1.2 非目标 / 暂不支持

- 不接入微信/支付宝等真实支付。
- 暂不做跨群红包（红包只在创建所在 chat 内有效）。
- 暂不做复杂风控（仅做基础额度和频率限制）。

---

## 2. 数据模型设计

### 2.1 红包主表 `red_packets`

> 存储每一个红包的总体信息。

| 字段名              | 类型                      | 说明 |
|---------------------|---------------------------|------|
| id                  | Int, PK                   | 红包主键 ID |
| chat_id             | BigInt, Index             | 所在群/聊天 ID |
| message_id          | BigInt, Nullable          | 绑定的红包消息 ID（群内那条“红包封面”消息） |
| creator_user_id     | BigInt, Index             | 发红包用户 ID |
| total_amount        | Int                       | 红包总金额（使用精粹最小单位的整数，对应 `currency_balance`） |
| packet_count        | Int                       | 红包份数（最大可领取人数） |
| packet_type         | Enum(fixed,random,exclusive)| 红包类型：固定金额 / 拼手气 / 专属红包 |
| target_user_id      | BigInt, Nullable, Index   | 专属红包目标用户 ID（仅 `exclusive` 有效） |
| taken_count         | Int                       | 已领取份数 |
| taken_amount        | Int                       | 已领取金额合计 |
| status              | Enum(active,finished,expired,cancelled) | 状态：进行中 / 已领完 / 已过期 / 已撤销 |
| expire_at           | DateTime, Index           | 过期时间 |
| cover_template_id   | Int, Nullable             | 红包封面模板 ID（预制样式，如“普通/专属/口令”） |
| cover_image_file_id | String(256), Nullable     | 实际用于发送的红包封面 Telegram file_id（生成后缓存） |
| message_text        | Text, Nullable            | 用户自定义留言（如“新年快乐”），为空时系统会随机填充一条默认祝福语 |
| created_at          | DateTime                  | 创建时间（BasicAuditMixin） |
| updated_at          | DateTime                  | 更新时间（BasicAuditMixin） |
| created_by          | BigInt                    | 创建者 ID（BasicAuditMixin） |
| updated_by          | BigInt, Nullable          | 更新者 ID（BasicAuditMixin） |
| is_deleted          | Boolean                   | 是否软删除（BasicAuditMixin） |
| deleted_at          | DateTime, Nullable        | 删除时间（BasicAuditMixin） |
| deleted_by          | BigInt, Nullable          | 删除者 ID（BasicAuditMixin） |
| remark              | Text, Nullable            | 备注（BasicAuditMixin，用于管理说明等） |

索引建议：

- `idx_redpacket_chat_message (chat_id, message_id)`
- `idx_redpacket_creator (creator_user_id, created_at)`
- `idx_redpacket_status (status, expire_at)`

> 说明：
>
> - 货币类型固定复用现有经济系统的精粹，不再单独存 `currency_type` 字段，减少冗余。
> - `cover_template_id + cover_image_file_id` 支持“仿微信红包样式的封面图”：
>   - 通过模板定义基础样式；
>   - 生成实际封面图时将发送者头像、留言、金额、份数渲染到一张图片上并上传，得到 `file_id`。
> - `caption` 负责承载详细说明文字，不在图片上堆过多文字，兼顾美观与可读性。

### 2.2 红包领取表 `red_packet_claims`

> 记录每个用户对某个红包的具体领取情况。

| 字段名         | 类型          | 说明 |
|----------------|---------------|------|
| id             | Int, PK       | 领取记录主键 |
| packet_id      | Int, FK       | 对应 `red_packets.id` |
| user_id        | BigInt, Index | 领取用户 ID |
| amount         | Int           | 领取金额（单位与 `currency_balance` 一致） |
| is_rolled_back | Boolean       | 是否已回滚（对应红包撤销或异常回退） |
| created_at     | DateTime      | 创建时间（BasicAuditMixin） |
| updated_at     | DateTime      | 更新时间（BasicAuditMixin） |
| created_by     | BigInt        | 创建者 ID（BasicAuditMixin） |
| updated_by     | BigInt, Nullable | 更新者 ID（BasicAuditMixin） |
| is_deleted     | Boolean       | 是否软删除（BasicAuditMixin） |
| deleted_at     | DateTime, Nullable | 删除时间（BasicAuditMixin） |
| deleted_by     | BigInt, Nullable | 删除者 ID（BasicAuditMixin） |

约束与索引：

- 唯一约束：`uniq_red_packet_claim (packet_id, user_id)`，防止重复领取。
- 按用户查询索引：`idx_red_packet_claim_user (user_id, created_at)`。

### 2.3 与货币 / 积分系统的关系

经济系统已经通过 `CurrencyService` 实现统一的加减精粹逻辑，红包模块只是在其之上做业务封装，不单独维护余额。

核心接口参考：

- `CurrencyService.get_user_balance(session, user_id)`：查询当前余额。
- `CurrencyService.add_currency(session, user_id, amount, event_type, description, meta=None, is_consumed=True, commit=True)`：
  - `amount > 0` 表示增加精粹；
  - `amount < 0` 表示扣除精粹；
  - 统一写入 `CurrencyTransactionModel`，并更新 `UserExtendModel.currency_balance`。

红包与货币系统的关系（建议事件类型与 meta 结构）：

- 发红包（创建时预先扣款）：
  - 调用：

    ```python
    await CurrencyService.add_currency(
        session=session,
        user_id=creator_user_id,
        amount=-total_amount,
        event_type="red_packet_create",
        description=f"发红包，金额 {total_amount}",
        meta={
            "packet_id": packet_id,
            "chat_id": chat_id,
            "packet_type": packet_type,
        },
        is_consumed=True,
        commit=False,  # 由外层事务统一提交
    )
    ```

  - 扣款成功后创建 `red_packets` 记录。

- 抢红包成功（给领取者加钱）：

  - 调用：

    ```python
    await CurrencyService.add_currency(
        session=session,
        user_id=user_id,
        amount=claim_amount,
        event_type="red_packet_claim",
        description=f"抢到红包 {claim_amount}",
        meta={
            "packet_id": packet_id,
            "chat_id": chat_id,
            "creator_user_id": creator_user_id,
        },
        is_consumed=True,
        commit=False,
    )
    ```

  - 同时创建 `red_packet_claims` 记录，并更新 `red_packets` 的统计字段。

- 红包过期退款（未领完部分退回给发起人）：

  - 计算 `remaining = total_amount - taken_amount`。
  - 若 `remaining > 0`，调用：

    ```python
    await CurrencyService.add_currency(
        session=session,
        user_id=creator_user_id,
        amount=remaining,
        event_type="red_packet_refund",
        description=f"红包过期退款 {remaining}",
        meta={
            "packet_id": packet_id,
            "chat_id": chat_id,
        },
        is_consumed=True,
        commit=False,
    )
    ```

所有与红包相关的精粹变动，都通过上述三类 `event_type` 记录在 `currency_transactions` 中，便于后期审计和统计。

---

## 3. 业务规则与流程

### 3.1 发红包业务规则

- 参数校验：
  - `total_amount` 必须为正整数。
  - `packet_count` 必须为正整数。
  - `total_amount >= packet_count`（保证每份至少 1 单位）。
  - 金额与份数上限受全局配置控制：
    - 每个红包最大金额，例如 10,000 单位。
    - 每个红包最大份数，例如 100 份。
- 余额校验：
  - 发红包前必须从用户账户中预先扣除 `total_amount`。
  - 余额不足时直接拒绝。
- 过期时间：
  - 默认过期时间可配置：例如 10 分钟 / 30 分钟。
  - `expire_at = now() + expire_minutes`。
- 状态流转：
  - 创建时：`status = active`。
  - 全部领完：`status = finished`。
  - 超时未领完：定时任务或惰性检查将其标记为 `expired` 并退款。
  - 管理员手动撤销：`status = cancelled`，按规则退款已领取/未领取部分。

- 留言规则：
  - 用户在发红包时可以选择输入一段留言（如“新年快乐”）；
  - 如果用户未填写留言，系统会从预置的祝福语列表中随机选择一条填充到 `message_text` 字段；
  - 留言会显示在红包封面以及 caption 中。

- 专属红包（exclusive）规则：
  - `packet_type = exclusive` 时：
    - `packet_count` 默认 1（单人限领）。
    - 必须指定 `target_user_id`，来源有两种：
      - 方式一：在命令参数中传入第二个参数为用户标识（如 `@username` 或数字 ID）；
      - 方式二：在**回复某个用户的消息**时发送 `/rp ...`，自动将该用户作为 `target_user_id`；
    - 抢红包时仅当 `user_id == target_user_id` 时才允许领取；
    - 其他用户点击时返回提示文案，例如“这是给某某的专属红包，你下次也试试发一个～”。

### 3.2 抢红包业务规则

- 基本约束：
  - 同一用户对同一红包只能领取一次（依赖唯一约束）。
  - 仅当红包 `status = active` 且 `now() < expire_at` 且 `taken_count < packet_count` 时可领取。
- 金额分配：
  - **固定金额红包（fixed）**：
    - 理论单份金额为 `avg = total_amount // packet_count`。
    - 实际实现可以简化为：每份 `avg`，多余的余数在最后一份补差，或全部算入第一份。
  - **拼手气红包（random）**：
    - 在剩余金额 `R`，剩余份数 `N` 的条件下分配本次金额 `a`：
      - `min_amount <= a <= max_amount`。
      - `min_amount` >= 1。
      - `max_amount` 可以控制为 `R - (N-1)*min_amount` 的某个比例（例如最多不超过剩余金额的 50%），减少极端值。
- 并发控制：
  - 抢红包请求必须在事务中执行。
  - 可以通过数据库行级锁或乐观锁控制：
    - 更新语句中带上条件：`status = 'active' AND taken_count < packet_count AND taken_amount + a <= total_amount`。
  - 如果更新失败，重试一次或提示红包已被抢光。

### 3.3 红包过期处理

触发方式可以有两种：

1. 定时任务：
   - 定期扫描 `status = active AND expire_at < now()` 的红包。
   - 对每条执行退款逻辑，并标记为 `expired`。
2. 惰性检查：
   - 用户抢红包时，如果发现 `expire_at < now()`，则：
     - 在当前事务里将红包标记为 `expired`。
     - 计算剩余金额并退款。

推荐做法：

- 支持惰性检查保证正确性；
- 再通过一个低频定时任务兜底清理，以防长期没有交互。

---

## 4. 交互设计（Telegram 维度）

### 4.1 发红包命令格式

建议在群聊中通过命令 `/rp` 触发（与 red packet 对应，简短好记），命令参数结构统一为：

```text
/rp 金额 [份数或目标用户] [类型] [留言...]
```

- **普通拼手气红包（默认）**：

  ```text
  /rp 100 5
  ```

  含义：总额 100，5 份，**不写类型参数时默认拼手气**，无自定义留言。

  带留言：

  ```text
  /rp 100 5 新年快乐，大家一起玩～
  ```

  解析规则：前两个参数是数字（金额、份数），后面整段视为 `message_text`。

- **固定金额红包（平均分）**：

  ```text
  /rp 100 5 fixed
  ```

  含义：总额 100，5 份，平均分配（最后一份补差），无自定义留言。

  带留言：

  ```text
  /rp 100 5 fixed 新年快乐，人人有份
  ```

  解析规则：第三个参数为类型 `fixed`，从第四个参数起合并为 `message_text`。

- **专属红包（给某人的单人红包）**：

  - 方式一：直接指定目标用户（如使用 @username 或数字 ID）：

    ```text
    /rp 100 @alice 新年快乐，专属给你
    ```

    含义：给 @alice 发一个 100 精粹的专属红包，`packet_count = 1`，留言为“新年快乐，专属给你”。

    解析规则：第二个参数不是纯数字 → 视为用户标识 `target_user_id`，从第三个参数起整段为 `message_text`。

  - 方式二：**回复某人的消息**使用 `/rp`：

    ```text
    （回复 Alice 的一条消息）
    /rp 100 新年快乐
    ```

    含义：给被回复的这位用户发一个 100 精粹的专属红包，`packet_count = 1`，留言为“新年快乐”。

    解析规则：在有 `reply_to_message` 的情况下：
    - 第一个参数为金额；
    - 从第二个参数起整段为 `message_text`；
    - `target_user_id` 来自被回复消息的发送者。

  如果用户未填写留言（`message_text` 为空），系统从预置祝福语列表中随机选择一条填充。

### 4.2 红包消息样式（封面 + caption）

创建成功后，在群内发送一张“红包封面图”，参考微信红包的统一视觉风格：

- 封面图内容（由服务端生成图片，上传得到 `cover_image_file_id`，同时在本地落盘保存一份用于审计/调试）：
  - 红色主色调背景 + 项目统一样式；
  - 左上角：小头像区域，展示**发送者头像**（从 Telegram 获取用户头像并裁剪后贴到模板上）；
  - 中部：红包留言（如“新年快乐，大家一起玩～”），过长时在图片中做简短截断；
  - 底部：
    - 显示红包总金额（例如 `100 精粹`）；
    - 显示份数（例如 `5 个红包`）；
    - 可选显示红包类型标签（如“拼手气红包”、“专属红包”）。

- caption 文案：

  由 handler 构造更详细的说明，例如：

  ```text
  🧧 某某 发了一个红包
  💰 总额：100 精粹（5 份，拼手气）
  ⏰ 有效期：10 分钟
  📝 留言：新年快乐，大家一起玩～
  ```

- inline button：

  - `[抢红包]`
    - `callback_data = "redpacket:claim:<packet_id>"`

- 红包抢完后的展示：
  - 通过 `editMessageCaption` 编辑**同一条红包消息**，改为“红包已被领完”的摘要：

    ```text
    ✅ 红包已被领完
    💰 总额：100 精粹，已全部派发
    👥 领取人数：5 / 5
    ```

  - 若详细领取记录（谁抢了多少）文字过长：
    - 只在 caption 中保留简要汇总；
    - 由 bot 再发送一条**回复该红包消息**的普通文本消息，展示完整明细列表，文案示例：

    ```text
    🎉 红包领取详情
    1）Alice 抢到 30 精粹
    2）Bob 抢到 25 精粹
    3）Carol 抢到 20 精粹
    4）Dave 抢到 15 精粹
    5）Eve 抢到 10 精粹
    ```

### 4.3 抢红包反馈

- 抢成功：
  - 私聊 toast 或 Alert：

    ```text
    🎉 你抢到了 7 个金币！
    ```

  - 可选群内提示（视群内噪音情况决定是否开启）：

    ```text
    某某 抢到了 7 个金币（剩余 3/5 份）
    ```

- 抢失败：
  - 红包已领完：

    ```text
    ❌ 红包已经被抢完啦
    ```

  - 红包已过期：

    ```text
    ❌ 红包已过期，下次手速快一点～
    ```

  - 已经抢过：

    ```text
    ℹ️ 你已经抢过这个红包啦
    ```

---

## 5. 模块划分与代码结构

### 5.1 数据模型层（database/models）

- `red_packet.py`（建议新建）：
  - `RedPacketModel`
  - `RedPacketClaimModel`
- 继承项目已有的 `Base` 与 `BasicAuditMixin`，保持审计字段统一。

### 5.2 服务层（services）

- `red_packet_service.py`：
  - `create_red_packet(...)`：负责参数校验、余额扣除、红包记录创建。
  - `claim_red_packet(...)`：负责并发安全的领取逻辑、金额计算、写领取记录和货币流水。
  - `expire_red_packet(...)`：负责过期处理和退款逻辑。

接口示意：

```python
class RedPacketService:
    async def create_red_packet(
        self,
        session: AsyncSession,
        creator_id: int,
        chat_id: int,
        total_amount: int,
        count: int,
        packet_type: RedPacketType,
        expire_minutes: int = 10,
    ) -> RedPacketModel: ...

    async def claim_red_packet(
        self,
        session: AsyncSession,
        packet_id: int,
        user_id: int,
    ) -> ClaimResult: ...

    async def expire_red_packet(
        self,
        session: AsyncSession,
        packet_id: int,
    ) -> None: ...
```

`ClaimResult` 可包含：

- `success: bool`
- `reason: str | None`
- `amount: int | None`
- `finished: bool`（红包是否在本次领取后已领完）

### 5.3 Handler 层（handlers）

遵循项目的目录规范，命令 handler 放在：

- `bot/handlers/command/user/red_packet.py`（示例路径）

职责：

- 接收 `/redpacket` 命令，解析参数。
- 调用 `RedPacketService.create_red_packet`。
- 构造 Telegram 消息和 inline keyboard。

抢红包的 callback handler：

- 同样放在 user 命令相关 handler 中，使用 `@router.callback_query`：
  - 解析 `callback_data` 中的 `packet_id`。
  - 调用 `RedPacketService.claim_red_packet`。
  - 根据结果反馈给用户。

---

## 6. 安全与风控初步考虑

### 6.1 滥用防护

- 频率限制：
  - 同一用户在一定时间内可创建的红包数量限制（例如每小时最多 10 个）。
- 金额限制：
  - 单个红包最大金额。
  - 单日发红包总金额上限。

### 6.2 数据一致性

- 所有涉及余额变化的操作必须在数据库事务中执行。
- 抢红包时的并发控制要确保：
  - 不会出现超发（领取总额超过总金额）。
  - 不会出现重复领取。

---

## 7. 后续扩展方向（预留）

- 口令红包：
  - 红包带有口令，只有发送正确口令的用户才能领取。
- 定向红包：
  - 限定某些用户 ID 或拥有特定权限/勋章的用户才能领取。
- UI / 可视化：
  - 在管理面板中展示红包统计、Top 发红包/抢红包用户等。
- 和精粹商店联动：
  - 通过购买道具解锁发红包功能，或解锁更大的红包额度。
