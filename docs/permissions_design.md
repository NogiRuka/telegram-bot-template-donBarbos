# Telegram 机器人权限设计文档

## 目标与原则
- 明确三种角色分层：`user`（普通用户）、`admin`（管理员）、`owner`（所有者）
- 配置驱动，便于在 `.env` 中灵活调整，无需改动代码即生效
- 最小权限原则：默认仅开放必要能力，敏感操作需更高权限
- 兼容迁移：现有“超管”过渡为单一 `owner`，同时保留兼容变量，逐步平滑迁移

## 角色定义
- `user`：普通用户，默认权限，使用日常查询与交互功能
- `admin`：管理员，可执行管理相关操作（如群配置、导出、批量操作等），可有多个
- `owner`：所有者，系统最高权限，仅有一个，具备全量管理与危险操作权限

## 配置源（Source of Truth）
- 环境变量（`.env`）
  - `OWNER_ID`：所有者用户 ID（必填、唯一）
  - `ADMIN_IDS`：管理员用户 ID 列表（可选，逗号分隔，如 `123,456,789`）
  - 兼容变量（仅迁移期保留，后续移除）：
    - `SUPER_ADMIN_IDS`：旧版“超管”列表；迁移期将其中第一个或唯一值与 `OWNER_ID` 对齐

> 示例：
```
OWNER_ID=1369588230
ADMIN_IDS=123456789,987654321
```

## 身份判定规则
1. 从 Telegram 更新中读取发起者 `user_id`
2. 若 `user_id == OWNER_ID`，则角色为 `owner`
3. 否则若 `user_id ∈ ADMIN_IDS`，则角色为 `admin`
4. 否则角色为 `user`

## 权限矩阵（示例）
- `user`
  - 查询与信息类命令：如 `/start`、`/info`、菜单浏览
  - 个人数据导出（如允许）
- `admin`
  - 群配置相关：启用/禁用消息保存、策略调整、批量导出
  - 用户管理相关：标记、统计查看、数据分析
  - 批量操作：如批量删除、批量导出（受速率与安全策略限制）
- `owner`
  - 系统级操作：管理员名单调整、敏感参数修改
  - 危险操作：服务重启、运行状态切换（如 webhook/轮询）、数据清理与迁移确认
  - 最高优先权：可绕过部分保护以进行紧急处置（需要额外二次确认）

## 设计落点与接入点
- 中间件层（`bot/middlewares/auth.py`）
  - 鉴权拦截：在处理器前识别角色并注入上下文（如 `request.role`）
  - 失败处理：给出友好提示（例如“需要管理员权限”）
- 处理器层（`bot/handlers/*`）
  - 按角色路由：将敏感命令分配到 `admin` 或 `owner` 的专属处理器
  - 二次确认：对危险操作要求交互确认（按钮/文本验证码）
- API 层（`bot/api/routes/*`）
  - 标注路由所需角色，统一在依赖或中间件中进行校验

## 迁移方案
1. 配置层
   - 在 `.env` 与 `.env.example` 增加 `OWNER_ID` 与 `ADMIN_IDS`（已完成）
   - 保留 `SUPER_ADMIN_IDS`（兼容期），并建议将其第一个值对齐到 `OWNER_ID`
2. 代码层（后续任务）
   - `bot/core/config.py` 增加解析 `OWNER_ID` 与 `ADMIN_IDS`，保留旧字段的兼容读取
   - `bot/middlewares/auth.py` 与各处理器按新角色判定进行权限校验
   - README 与文档更新，统一对外术语

## 错误处理与边界
- 缺少 `OWNER_ID`：启动时直接失败（后续在配置校验阶段强制）
- `ADMIN_IDS` 为空：可以，表示无管理员，仅 `owner` 与 `user`
- 非法 ID 格式：仅允许数字；发现非法时拒绝启动或忽略非法项并记录告警
- 角色冲突：若 `OWNER_ID` 同时包含在 `ADMIN_IDS` 中，按 `owner` 处理；建议文档强调避免冲突

## 安全与速率控制
- Telegram API 限制：
  - 单条消息最大约 4096 字符（文本），媒体等另有限制
  - 需遵守调用频率，避免短时间大量操作导致限流
- 管理操作建议：
  - 批量操作分批进行，并在 UI/命令层提示耗时与进度
  - 对危险操作（删除/清理/迁移）加确认与日志记录

## 示例交互（后续实现参考）
- 查询角色：`/role` 返回当前用户的角色与可用命令列表
- 设置管理员：仅 `owner` 可用，如 `/admin_add 123456789`、`/admin_remove 123456789`
- 查看管理员列表：`/admin_list`

## Windows 兼容性
- 环境变量与 `.env` 文件使用 UTF-8，无 BOM
- 路径展示以 Windows 风格为主（如 `c:\path\to\file`）

## 验收与评审点
- `.env` 示例是否清晰标注必填与可选项
- 角色定义与权限矩阵是否满足使用场景
- 迁移与兼容策略是否可平滑过渡、无用户感知中断
- 错误与边界处理是否明确、可执行

