# æ–°å¢èŠ‚ç›®é€šçŸ¥åŠŸèƒ½å®ç°è¯¦è§£

## 1. æ ¸å¿ƒæµç¨‹æ¦‚è¿°

å½“ Emby åª’ä½“åº“æœ‰æ–°å†…å®¹åŠ å…¥æ—¶ï¼Œä¼šå‘é…ç½®çš„ Webhook åœ°å€å‘é€ `POST` è¯·æ±‚ã€‚æœ¬é¡¹ç›®é€šè¿‡ `WebhookHandler` æ¥æ”¶å¹¶å¤„ç†è¯¥è¯·æ±‚ï¼Œç»è¿‡å…ƒæ•°æ®è¡¥å……ã€TMDB ä¿¡æ¯è·å–ã€è§„æ ¼åˆ†æã€æ¶ˆæ¯æ ¼å¼åŒ–ç­‰æ­¥éª¤ï¼Œæœ€ç»ˆæ¨é€åˆ° Telegramã€‚

**ä¸»è¦æ­¥éª¤ï¼š**
1. **æ¥æ”¶äº‹ä»¶**ï¼šç›‘å¬ `library.new` äº‹ä»¶ã€‚
2. **è¡¥å……å…ƒæ•°æ®**ï¼šè°ƒç”¨ Emby API è·å–å®Œæ•´é¡¹ç›®ä¿¡æ¯ã€‚
3. **è·å–è¯¦æƒ…**ï¼šæŸ¥è¯¢ TMDB è·å–æµ·æŠ¥ã€è¯„åˆ†ã€å‰§æƒ…ç­‰ã€‚
4. **åˆ†æè§„æ ¼**ï¼šè·å–è§†é¢‘åˆ†è¾¨ç‡ã€éŸ³è½¨ã€å­—å¹•ç­‰åª’ä½“æµä¿¡æ¯ã€‚
5. **è¿›åº¦è®¡ç®—**ï¼šé’ˆå¯¹å‰§é›†ï¼Œè®¡ç®—æ›´æ–°è¿›åº¦ï¼ˆå¦‚ï¼šå·²æ›´æ–°è‡³ S01E05ï¼Œç¼ºé›† E02ï¼‰ã€‚
6. **æ¶ˆæ¯æ„é€ **ï¼šæ‹¼æ¥æ ‡é¢˜ã€æµ·æŠ¥ã€æ ‡ç­¾ã€ç®€ä»‹ã€è§„æ ¼ã€è¿›åº¦ã€æ—¶é—´ç­‰å­—æ®µã€‚
7. **æ¨é€æ¶ˆæ¯**ï¼šåˆ†å‘è‡³ç¾¤ç»„ã€é¢‘é“æˆ–ç®¡ç†å‘˜ç§èŠã€‚

---

## 2. è¯¦ç»†å®ç°æ­¥éª¤

### 2.1 æ¥æ”¶ä¸é¢„å¤„ç†
- **å…¥å£**ï¼š`WebhookHandler.do_POST` (`app.py:4469`)
- **äº‹ä»¶åˆ¤æ–­**ï¼šæ£€æŸ¥ `Event` å­—æ®µæ˜¯å¦ä¸º `library.new`ã€‚

{
  "Title": "æ–° æµ‹è¯•å½±ç‰‡ JBYS åœ¨ æ¡œè‰²ç”·å­©âš£ğŸ”",
  "Description": "2025å¹´12æœˆ10æ—¥æ˜ŸæœŸä¸‰ ä¸‹åˆ7:46",
  "Date": "2025-12-10T18:46:44.2495477Z",
  "Event": "library.new",
  "Item": {
    "Name": "æµ‹è¯•å½±ç‰‡ JBYS",
    "ServerId": "6a166db9cacf467baef7fcfc5cbf8b46",
    "Id": "12761",
    "DateCreated": "2025-12-10T18:38:18.0956818Z",
    "Container": "mp4",
    "SortName": "æµ‹è¯•å½±ç‰‡ JBYS",
    "ExternalUrls": [],
    "Path": "/mnt/p1/bot/æµ‹è¯•å½±ç‰‡ JBYS/JBYS.mp4",
    "Taglines": [],
    "Genres": [],
    "RunTimeTicks": 7728070000,
    "Size": 298762848,
    "FileName": "JBYS.mp4",
    "Bitrate": 3092755,
    "RemoteTrailers": [],
    "ProviderIds": {},
    "IsFolder": false,
    "ParentId": "12759",
    "Type": "Movie",
    "Studios": [],
    "GenreItems": [],
    "TagItems": [],
    "PrimaryImageAspectRatio": 0.562962962962963,
    "ImageTags": {
      "Primary": "716214d13fe34eb4dd9f9f66afedff0d"
    },
    "BackdropImageTags": [],
    "MediaType": "Video",
    "Width": 608,
    "Height": 1080
  },
  "Server": {
    "Name": "æ¡œè‰²ç”·å­©âš£ğŸ”",
    "Id": "6a166db9cacf467baef7fcfc5cbf8b46",
    "Version": "4.8.11.0"
  }
}

- **å¼€å…³æ£€æŸ¥**ï¼šè‹¥ `settings.notification_management.library_new` ä¸‹çš„æ‰€æœ‰ç›®æ ‡ï¼ˆç¾¤ç»„/é¢‘é“/ç§èŠï¼‰å‡å…³é—­ï¼Œåˆ™ç›´æ¥è·³è¿‡ã€‚

### 2.2 å…ƒæ•°æ®è¡¥å……
- **åŸå› **ï¼šWebhook æ¨é€çš„åŸå§‹æ•°æ®å¯èƒ½ä¸åŒ…å« `Path`ã€`ProviderIds`ï¼ˆç”¨äº TMDB åŒ¹é…ï¼‰æˆ– `Overview`ã€‚
- **æ“ä½œ**ï¼šè°ƒç”¨ `GET /Users/{UserID}/Items/{Id}`ã€‚
- **ä»£ç ä½ç½®**ï¼š`app.py:4522`

### 2.3 è·å–åª’ä½“è¯¦æƒ… (TMDB)
- **å‡½æ•°**ï¼š`get_media_details(item, user_id)` (`app.py:1377`)
- **é€»è¾‘**ï¼š
  - æå– `ProviderIds.Tmdb`ã€‚
  - è‹¥ä¸ºå•é›† (`Episode`) ä¸”æ—  TMDB IDï¼Œå°è¯•å›æº¯è·å–æ‰€å±å‰§é›† (`Series`) çš„ TMDB IDã€‚
  - è°ƒç”¨ TMDB API è·å–æµ·æŠ¥ URLã€èƒŒæ™¯å›¾ã€TMDb é“¾æ¥ç­‰ã€‚
  - **æµ·æŠ¥ç¼“å­˜**ï¼šä¸ºå‡å°‘è¯·æ±‚ï¼ŒTMDB ç»“æœä¼šç¼“å­˜åˆ°æœ¬åœ° (`poster_cache.json`)ï¼Œæœ‰æ•ˆæœŸé»˜è®¤ 30 å¤©ã€‚

### 2.4 åª’ä½“è§„æ ¼åˆ†æ (Stream Details)
- **ç›®æ ‡**ï¼šè·å–åˆ†è¾¨ç‡ (4K/1080P)ã€ç¼–ç  (HEVC/AVC)ã€HDR (Dolby Vision)ã€éŸ³è½¨ (Atmos/DTS)ã€å­—å¹•è¯­è¨€ç­‰ã€‚
- **ç­–ç•¥**ï¼š
  - **ç”µå½±**ï¼šç›´æ¥è·å–è¯¥é¡¹ç›®çš„åª’ä½“æµã€‚å›  Emby å¯èƒ½å°šæœªå®Œæˆåˆ†æï¼Œä»£ç ä¸­åŠ å…¥äº† `time.sleep(30)` ç­‰å¾…æœºåˆ¶ (`app.py:4580`)ã€‚
  - **å‰§é›†**ï¼šé‡‡ç”¨**ä¸‰æ®µå¼å›é€€ç­–ç•¥** (`app.py:4540`)ï¼š
    1. **æœ¬æ¬¡æ–°å¢é›†**ï¼šæ£€æŸ¥ Webhook æè¿°ä¸­æåŠçš„å…·ä½“é›†æ•°ã€‚
    2. **åŒå­£å‚è€ƒé›†**ï¼šè‹¥ç­–ç•¥ 1 å¤±è´¥ï¼ŒæŸ¥æ‰¾åŒå­£åº¦çš„å…¶ä»–å·²å­˜åœ¨é›†æ•°ä½œä¸ºå‚è€ƒã€‚
    3. **æœ€æ–°é›†å…œåº•**ï¼šè‹¥å‰ä¸¤è€…å‡å¤±è´¥ï¼Œè·å–è¯¥å‰§é›†åº“ä¸­æœ€æ–°ä¸€é›†çš„è§„æ ¼ã€‚
- **æ ¼å¼åŒ–**ï¼š`format_stream_details_message` (`app.py:2330`) å°†æŠ€æœ¯å‚æ•°è½¬ä¸ºæ˜“è¯»æ–‡æœ¬ï¼ˆå¦‚ `è§†é¢‘ï¼šHEVC 4K â€¢ HDR`ï¼‰ã€‚

### 2.5 å‰§é›†è¿›åº¦ä¸ç¼ºé›†æ£€æµ‹
- **å‡½æ•°**ï¼š`build_progress_lines_for_library_new` -> `build_seasonwise_progress_and_missing_lines` (`app.py:2187`)
- **é€»è¾‘**ï¼š
  - å¯¹æ¯” **æœ¬åœ°åº“** ä¸ **TMDB æ•°æ®**ã€‚
  - **è¿›åº¦**ï¼šè®¡ç®—â€œå‰©ä½™é›†æ•°â€æˆ–æ˜¾ç¤ºâ€œå·²å®Œç»“â€ã€‚
  - **ç¼ºé›†**ï¼šè¯†åˆ«ä¸­é—´ç¼ºå¤±çš„é›†æ•°ï¼ˆå¦‚æœ¬åœ°æœ‰ E01, E03ï¼Œåˆ™æç¤ºç¼º E02ï¼‰ã€‚
  - **å±•ç¤º**ï¼šä»…åœ¨â€œæœ€æ–°å­£â€æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ï¼Œæ—§å­£åº¦ä»…æç¤ºç¼ºé›†ã€‚

### 2.6 æ¶ˆæ¯æ„é€ ä¸å‘é€
- **å†…å®¹æ‹¼æ¥**ï¼š
  - **æ ‡é¢˜**ï¼š`ä¸­æ–‡å (å¹´ä»½) S01E01`ï¼Œæ”¯æŒæ·»åŠ  TMDB è¶…é“¾æ¥ã€‚
  - **ç±»å‹**ï¼šç”µå½± / å‰§é›† / èŠ‚ç›®ç±»å‹ï¼ˆå¦‚ `åŠ¨æ¼«`ï¼Œé€šè¿‡è·¯å¾„å…³é”®è¯æ¨æ–­ï¼‰ã€‚
  - **å‰§æƒ…**ï¼šæˆªå–å‰ 150 å­—ã€‚
  - **è§„æ ¼**ï¼šè§†é¢‘ã€éŸ³é¢‘ã€å­—å¹•ä¿¡æ¯ã€‚
  - **è¿›åº¦**ï¼šå¦‚ `æ›´æ–°è¿›åº¦ï¼šå‰©ä½™ 3 é›†`ã€‚
  - **æ—¶é—´**ï¼šå…¥åº“æ—¶é—´ã€‚
  - **æŒ‰é’®**ï¼š`â¡ï¸ åœ¨æœåŠ¡å™¨ä¸­æŸ¥çœ‹`ï¼ˆè·³è½¬ Emby Web æ’­æ”¾é¡µï¼‰ã€‚
- **å‘é€å‡½æ•°**ï¼š`send_telegram_notification` æˆ– `send_deletable_telegram_notification`ï¼ˆæ”¯æŒå®šæ—¶æ’¤å›ï¼‰ã€‚
- **ç›®æ ‡åˆ†å‘**ï¼šæ ¹æ® `config.yaml` é…ç½®ï¼Œåˆ†åˆ«å‘ Groupã€Channelã€Private å‘é€ã€‚

---

## 3. å…³é”®ä»£ç ç‰‡æ®µå‚è€ƒ

### è·å–åª’ä½“è¯¦æƒ…
```python
def get_media_details(item, user_id):
    # ... (çœç•¥éƒ¨åˆ†ä»£ç )
    if item_type == 'Series':
        tmdb_id = item.get('ProviderIds', {}).get('Tmdb')
        details['tmdb_link'] = f"https://www.themoviedb.org/tv/{tmdb_id}"
    # ...
    # æŸ¥ç¼“å­˜æˆ–è¯·æ±‚ TMDB API è·å– poster_path
```

### è§„æ ¼è·å–ç­–ç•¥ï¼ˆå‰§é›†ï¼‰
```python
if item.get('Type') == 'Series':
    # ç­–ç•¥ 1: æ£€æŸ¥æœ¬æ¬¡æ–°å¢çš„å‰§é›†
    # ...
    # ç­–ç•¥ 2: æ£€æŸ¥åŒå­£çš„å…¶ä»–å‰§é›†
    # ...
    # ç­–ç•¥ 3: å›é€€è‡³è·å–åª’ä½“åº“æœ€æ–°ä¸€é›†
    episode_item = _get_latest_episode_info(item.get('Id'))
    stream_details = get_media_stream_details(episode_item.get('Id'), EMBY_USER_ID)
```

### æ¶ˆæ¯å‘é€
```python
if get_setting('settings.notification_management.library_new.to_group') and GROUP_ID:
    if auto_delete_group:
        send_deletable_telegram_notification(message, photo_url, chat_id=GROUP_ID, ...)
    else:
        send_telegram_notification(message, photo_url, chat_id=GROUP_ID, ...)
```

---

## 4. å¸¸è§é—®é¢˜æ’æŸ¥

- **æ— é€šçŸ¥**ï¼š
  - æ£€æŸ¥ `config.yaml` ä¸­ `notification_management.library_new` æ˜¯å¦å¼€å¯ã€‚
  - æ£€æŸ¥ Emby Webhook æ˜¯å¦é…ç½®æ­£ç¡®ï¼Œä¸”å‹¾é€‰äº†â€œæ–°åª’ä½“â€äº‹ä»¶ã€‚
  - æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `âš ï¸ å·²å…³é—­æ–°å¢èŠ‚ç›®é€šçŸ¥ï¼Œè·³è¿‡ã€‚`ã€‚

- **æ— æµ·æŠ¥/è¯¦æƒ…**ï¼š
  - æ£€æŸ¥ `tmdb.api_token` æ˜¯å¦é…ç½®ã€‚
  - æ£€æŸ¥ç½‘ç»œæ˜¯å¦é€šç•…ï¼ˆéœ€ç¿»å¢™åˆ™é…ç½® `proxy.http_proxy`ï¼‰ã€‚
  - ç¡®è®¤ Emby åˆ®å‰Šå™¨å·²æ­£ç¡®è¯†åˆ«è¯¥é¡¹ç›®å¹¶å†™å…¥äº† `ProviderIds`ã€‚

- **è§„æ ¼æ˜¾ç¤ºâ€œæœªçŸ¥â€**ï¼š
  - å¯èƒ½æ˜¯ Emby å°šæœªå®Œæˆåª’ä½“åˆ†æï¼ˆffprobeï¼‰ã€‚
  - ç”µå½±é€šçŸ¥é»˜è®¤å»¶æ—¶ 30 ç§’ç­‰å¾…åˆ†æï¼Œè‹¥æ–‡ä»¶è¿‡å¤§å¯èƒ½ä»æœªå®Œæˆã€‚
  - æ£€æŸ¥ Emby ä¾§è¯¥è§†é¢‘æ˜¯å¦å·²æ­£å¸¸è¯†åˆ«åˆ†è¾¨ç‡å’Œç¼–ç ã€‚
