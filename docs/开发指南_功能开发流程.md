# åŠŸèƒ½å¼€å‘æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†åœ¨æœ¬é¡¹ç›®ä¸­å¼€å‘æ–°åŠŸèƒ½ï¼ˆç‰¹åˆ«æ˜¯æ¶‰åŠ Telegram äº¤äº’çš„åŠŸèƒ½ï¼‰çš„æ ‡å‡†æµç¨‹å’Œæœ€ä½³å®è·µã€‚

## 1. æ ¸å¿ƒæ¶æ„æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼š

*   **Handlers (`bot/handlers/`)**: å¤„ç† Telegram äº‹ä»¶ï¼ˆæ¶ˆæ¯ã€å›è°ƒã€å‘½ä»¤ï¼‰ã€‚æŒ‰è§’è‰²ï¼ˆç”¨æˆ·ã€ç®¡ç†å‘˜ã€æ‰€æœ‰è€…ï¼‰åˆ†æ–‡ä»¶å¤¹ç»„ç»‡ã€‚
*   **Keyboards (`bot/keyboards/`)**: å®šä¹‰å†…è”é”®ç›˜å’Œå›å¤é”®ç›˜ã€‚æ¨èä½¿ç”¨ `InlineKeyboardBuilder`ã€‚
*   **Services (`bot/services/`)**: ä¸šåŠ¡é€»è¾‘å±‚ï¼Œå¤„ç†æ•°æ®åº“æ“ä½œã€å¤–éƒ¨ API è°ƒç”¨ï¼ˆå¦‚ Embyï¼‰ç­‰ã€‚
*   **Database (`bot/database/`)**: å®šä¹‰ SQLAlchemy æ¨¡å‹å’Œæ•°æ®åº“è¿æ¥ã€‚
*   **Utils (`bot/utils/`)**: é€šç”¨å·¥å…·ï¼Œå…¶ä¸­ `view.py` æ˜¯å¤„ç†æ¶ˆæ¯è§†å›¾æ¸²æŸ“çš„æ ¸å¿ƒã€‚

---

## 2. åŠŸèƒ½å¼€å‘æ ‡å‡†æµç¨‹

### æ­¥éª¤ 1: éœ€æ±‚åˆ†æä¸æ•°æ®åº“è®¾è®¡
å¦‚æœåŠŸèƒ½éœ€è¦å­˜å‚¨æ•°æ®ï¼Œé¦–å…ˆåœ¨ `bot/database/models/` ä¸­å®šä¹‰æ–°çš„æ¨¡å‹ã€‚
*   ç»§æ‰¿ `Base` å’Œ `BasicAuditMixin`ã€‚
*   ä½¿ç”¨ `Mapped` å’Œ `mapped_column` å®šä¹‰å­—æ®µã€‚
*   è¿è¡Œ `alembic revision --autogenerate -m "message"` ç”Ÿæˆè¿ç§»è„šæœ¬ã€‚
*   è¿è¡Œ `alembic upgrade head` åº”ç”¨è¿ç§»ã€‚

### æ­¥éª¤ 2: å®šä¹‰ UI å…ƒç´  (Labels & Keyboards)
ä¸è¦åœ¨ Handler ä¸­ç¡¬ç¼–ç æ–‡æœ¬å’ŒæŒ‰é’®ã€‚
1.  **æ–‡æ¡ˆ (`bot/keyboards/inline/labels.py`)**:
    *   å°†æ‰€æœ‰æŒ‰é’®æ–‡æ¡ˆã€é€šç”¨æç¤ºè¯­å®šä¹‰ä¸ºå¸¸é‡ã€‚
    *   åŒºåˆ†åŠŸèƒ½åŒºåŸŸï¼ˆç”¨æˆ·/ç®¡ç†å‘˜/æ‰€æœ‰è€…ï¼‰ã€‚
2.  **é”®ç›˜ (`bot/keyboards/inline/`)**:
    *   åˆ›å»ºæ–°çš„é”®ç›˜æ„å»ºæ¨¡å—æˆ–åœ¨ç°æœ‰æ¨¡å—ä¸­æ·»åŠ å‡½æ•°ã€‚
    *   ä½¿ç”¨ `InlineKeyboardBuilder` æ„å»ºé”®ç›˜ã€‚
    *   å›è°ƒæ•°æ® (`callback_data`) å»ºè®®ä½¿ç”¨å†’å·åˆ†éš”çš„å‘½åç©ºé—´ï¼Œä¾‹å¦‚ `feature:action:id`ã€‚

### æ­¥éª¤ 3: ç¼–å†™ Handler (`bot/handlers/`)
1.  **åˆ›å»º Handler æ–‡ä»¶**: åœ¨å¯¹åº”è§’è‰²çš„ç›®å½•ä¸‹åˆ›å»º `.py` æ–‡ä»¶ã€‚
2.  **æ³¨å†Œ Router**: åˆ›å»º `router = Router(name="feature_name")`ã€‚
3.  **ç¼–å†™å›è°ƒå¤„ç†**:
    *   ä½¿ç”¨ `@router.callback_query(F.data.startswith("prefix:"))` è£…é¥°å™¨ã€‚
    *   **è§£æå‚æ•°**: ä» `callback.data` ä¸­æå–å‚æ•°ã€‚
    *   **ä¸šåŠ¡é€»è¾‘**: è°ƒç”¨ Service å±‚å¤„ç†ä¸šåŠ¡ã€‚
    *   **è§†å›¾æ¸²æŸ“**: ä½¿ç”¨ `MainMessageService` æ›´æ–°ç•Œé¢ï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ã€‚
    *   **åé¦ˆ**: åŠ¡å¿…è°ƒç”¨ `await callback.answer()` ç»“æŸåŠ è½½çŠ¶æ€ã€‚

### æ­¥éª¤ 4: æ³¨å†Œ Router
åœ¨å¯¹åº”æ¨¡å—çš„ `__init__.py` (å¦‚ `bot/handlers/admin/__init__.py`) ä¸­å¯¼å…¥å¹¶åŒ…å«æ–°åŠŸèƒ½çš„ Routerã€‚

### æ­¥éª¤ 5: é…ç½®ç®¡ç† (å¯é€‰)
å¦‚æœåŠŸèƒ½éœ€è¦å¼€å…³ï¼š
1.  åœ¨ `bot/core/config.py` æˆ–æ•°æ®åº“é…ç½®è¡¨ä¸­æ·»åŠ é…ç½®é¡¹ã€‚
2.  åœ¨ `bot/services/config_service.py` ä¸­å¤„ç†é…ç½®è¯»å–ã€‚
3.  åœ¨æ‰€æœ‰è€…é¢æ¿ (`bot/handlers/owner/`) æ·»åŠ å¼€å…³æ§åˆ¶ã€‚

---

## 3. è§†å›¾æ¸²æŸ“ä¸äº¤äº’è§„èŒƒ (å…³é”®)

æœ¬é¡¹ç›®ä½¿ç”¨ **`MainMessageService`** æ¥ç»Ÿä¸€ç®¡ç†æ¶ˆæ¯ç•Œé¢çš„æ›´æ–°ã€‚
**æ³¨æ„**: `bot.utils.view.render_view` å·²è¢«è§†ä¸ºåº•å±‚/æ—§å¼æ–¹æ³•ï¼Œä¸å†æ¨èç›´æ¥åœ¨ Handler ä¸­ä½¿ç”¨ã€‚è¯·ç»Ÿä¸€é€šè¿‡ `MainMessageService` è¿›è¡Œäº¤äº’ã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ MainMessageService?
*   **ç»Ÿä¸€å…¥å£**: è‡ªåŠ¨ç®¡ç†ç”¨æˆ·çš„ "Main Message" (ä¸»æ¶ˆæ¯) IDã€‚
*   **çŠ¶æ€ç»´æŠ¤**: è‡ªåŠ¨è®°å½•å½“å‰æœ€æ–°çš„æ¶ˆæ¯ IDï¼Œä¾¿äºåç»­æ›´æ–°ã€‚
*   **å¹³æ»‘ä½“éªŒ**: æ™ºèƒ½å¤„ç†å›¾ç‰‡/æ–‡æœ¬çš„åˆ‡æ¢ï¼Œä¼˜å…ˆç¼–è¾‘è€Œéé‡æ–°å‘é€ã€‚
*   **è‡ªåŠ¨æ¸…ç†**: æä¾› `delete_input` æ–¹æ³•è‡ªåŠ¨åˆ é™¤ç”¨æˆ·è¾“å…¥çš„ä¸´æ—¶æ¶ˆæ¯ã€‚

### âŒ é”™è¯¯åšæ³•
```python
# é”™è¯¯ 1: ç›´æ¥è°ƒç”¨åº•å±‚ API
await callback.message.edit_text("æ“ä½œæˆåŠŸ", reply_markup=kb)

# é”™è¯¯ 2: ç›´æ¥ä½¿ç”¨æ—§ç‰ˆå·¥å…·
from bot.utils.view import render_view
await render_view(callback.message, image, caption, kb)
```

### âœ… æ­£ç¡®åšæ³• (ä½¿ç”¨ MainMessageService)
```python
from bot.services.main_message import MainMessageService

# åœ¨ Handler ä¸­æ³¨å…¥ main_msg
@router.callback_query(...)
async def my_handler(callback: CallbackQuery, main_msg: MainMessageService):
    
    # 1. å‡†å¤‡æ•°æ®
    caption = "âœ… æ“ä½œæˆåŠŸ\n\nè¿™æ˜¯æ–°çš„ç•Œé¢å†…å®¹"
    kb = get_new_keyboard()
    
    # 2. æ›´æ–°è§†å›¾
    # update_on_callback ä¼šè‡ªåŠ¨å¤„ç†ç¼–è¾‘é€»è¾‘ï¼Œå¹¶è®°å½•è¿™æ¡æ¶ˆæ¯ä¸ºä¸»æ¶ˆæ¯
    await main_msg.update_on_callback(callback, caption, kb)
    
    # 3. ç»“æŸå›è°ƒ
    await callback.answer()
```

### å¸¸ç”¨æ–¹æ³•é€ŸæŸ¥
*   `send_main(...)`: é¦–æ¬¡å‘é€ä¸»æ¶ˆæ¯ (é€šå¸¸åœ¨ `/start`)ã€‚
*   `update_on_callback(...)`: å“åº”æŒ‰é’®ç‚¹å‡»ï¼Œæ›´æ–°å½“å‰æ¶ˆæ¯ã€‚
*   `update(user_id, ...)`: ä¸»åŠ¨æ›´æ–°æŒ‡å®šç”¨æˆ·çš„ä¸»æ¶ˆæ¯ (å¦‚å¼‚æ­¥ä»»åŠ¡å®Œæˆå)ã€‚
*   `delete_input(...)`: åˆ é™¤ç”¨æˆ·çš„æ–‡æœ¬è¾“å…¥æ¶ˆæ¯ã€‚

### äº¤äº’åé¦ˆ
*   **è½»é‡åé¦ˆ**: ä½¿ç”¨ `await callback.answer("æ“ä½œæˆåŠŸ")` (é¡¶éƒ¨æ¨ªå¹…æç¤º)ã€‚
*   **é‡è¦è­¦å‘Š**: ä½¿ç”¨ `await callback.answer("âŒ é”™è¯¯è¯´æ˜", show_alert=True)` (å¼¹çª—ç¡®è®¤)ã€‚
*   **è¿›åº¦æç¤º**: é¿å…å‘é€æ–°æ¶ˆæ¯æç¤ºè¿›åº¦ï¼Œæ¨èä½¿ç”¨ `show_alert=True` æˆ–ç›´æ¥åœ¨ä¸»ç•Œé¢æ›´æ–°çŠ¶æ€ã€‚
*   **ç•Œé¢è·³è½¬**: ä½¿ç”¨ `main_msg.update_on_callback` åˆ·æ–°å½“å‰æ¶ˆæ¯å†…å®¹ã€‚

---

## 4. ç¤ºä¾‹ï¼šæ·»åŠ ä¸€ä¸ªâ€œæŸ¥çœ‹è¯¦æƒ…â€åŠŸèƒ½

**1. Labels (`bot/keyboards/inline/labels.py`)**
```python
VIEW_DETAIL_LABEL = "ğŸ” æŸ¥çœ‹è¯¦æƒ…"
```

**2. Keyboards (`bot/keyboards/inline/example.py`)**
```python
from .labels import VIEW_DETAIL_LABEL, BACK_LABEL

def get_detail_keyboard(item_id: int):
    builder = InlineKeyboardBuilder()
    builder.button(text=BACK_LABEL, callback_data="list:back")
    return builder.as_markup()
```

**3. Handler (`bot/handlers/example.py`)**
```python
@router.callback_query(F.data.startswith("item:view:"))
async def show_item_detail(callback: types.CallbackQuery):
    item_id = callback.data.split(":")[-1]
    
    # ä¸šåŠ¡é€»è¾‘
    info = await get_item_info(item_id)
    
    # è§†å›¾æ›´æ–°
    caption = f"ğŸ“„ <b>{info.title}</b>\n\n{info.desc}"
    kb = get_detail_keyboard(item_id)
    
    await main_msg.update_on_callback(callback, caption, kb)
    await callback.answer()
```

---

## 5. æƒé™æ§åˆ¶

ä½¿ç”¨è£…é¥°å™¨è¿›è¡Œæƒé™éªŒè¯ï¼š
*   `@require_owner`: ä»…é™æ‰€æœ‰è€…ã€‚
*   `@require_admin`: ä»…é™ç®¡ç†å‘˜ã€‚

```python
from bot.utils.permissions import require_admin

@router.callback_query(...)
@require_admin
async def admin_action(...):
    ...
```

## 6. å¼‚å¸¸å¤„ç†

åŠ¡å¿…æ•è·å¯èƒ½å‘ç”Ÿçš„å¼‚å¸¸ï¼Œé˜²æ­¢æœºå™¨äººå´©æºƒï¼Œå¹¶ç»™å‡ºå‹å¥½æç¤ºã€‚

```python
try:
    # ä¸šåŠ¡é€»è¾‘
    ...
except Exception as e:
    logger.exception("å¤„ç†å¤±è´¥")
    await callback.answer("âŒ å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯", show_alert=True)
```
