# ğŸŒ¸ æ¡œä¹‹é—®ç­” (Sakura Quiz) - ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

> æ–‡æ¡£çŠ¶æ€ï¼š`Draft`  
> æœ€åæ›´æ–°ï¼š2025-12-30

## 1. æ ¸å¿ƒç†å¿µ

**â€œæŠŠç­”é¢˜å½“æˆä¸€ç§ã€Œéšæœºæ‰è½ã€çš„æƒŠå–œäº‹ä»¶ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ¯ç‡¥çš„åŠŸèƒ½å…¥å£ã€‚â€**

æœ¬ç³»ç»Ÿæ—¨åœ¨é€šè¿‡**è¢«åŠ¨è§¦å‘**çš„ BL å½±è§†é—®ç­”æŒ‘æˆ˜ï¼Œå¢åŠ ç”¨æˆ·ä¸æœºå™¨äººçš„äº’åŠ¨ä¹è¶£ã€‚ç”¨æˆ·åœ¨ä¸æœºå™¨äººæ­£å¸¸äº¤äº’æ—¶ï¼Œæœ‰æ¦‚ç‡è§¦å‘â€œçªè¢­â€é—®ç­”ï¼Œç­”å¯¹å¯è·å¾—é«˜é¢â€œç²¾ç²¹â€ï¼ˆç§¯åˆ†ï¼‰å¥–åŠ±ï¼Œç­”é”™ä¹Ÿæœ‰å®‰æ…°å¥–ã€‚

**æ ¸å¿ƒä½“éªŒå…³é”®è¯**ï¼š`éšæœº`ã€`çªè¢­`ã€`é™æ—¶`ã€`é«˜å›æŠ¥`

---

## 2. äº¤äº’æµç¨‹è®¾è®¡

### 2.1 è§¦å‘æœºåˆ¶
ç³»ç»Ÿä¸æä¾›ä¸»åŠ¨â€œå¼€å§‹ç­”é¢˜â€çš„èœå•å…¥å£ï¼Œè€Œæ˜¯é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼è§¦å‘ï¼š

1.  **äº¤äº’è§¦å‘ï¼ˆä¸»åŠ›ï¼‰**ï¼š
    *   ç”¨æˆ·å‘é€æ¶ˆæ¯ã€ç‚¹å‡»æŒ‰é’®æˆ–æ‰§è¡Œå‘½ä»¤æ—¶ã€‚
    *   ç³»ç»Ÿè¿›è¡Œæ¦‚ç‡åˆ¤å®šï¼ˆä¾‹å¦‚ 5% æ¦‚ç‡ï¼‰ã€‚
    *   **é™åˆ¶æ¡ä»¶**ï¼š
        *   ç”¨æˆ·ä¸åœ¨â€œç­”é¢˜å†·å´æœŸâ€å†…ï¼ˆä¾‹å¦‚è·ç¦»ä¸Šæ¬¡ç­”é¢˜ > 10åˆ†é’Ÿï¼‰ã€‚
        *   ç”¨æˆ·å½“å‰æ²¡æœ‰æœªå®Œæˆçš„é¢˜ç›®ã€‚
        *   æ¯æ—¥è§¦å‘æ¬¡æ•°æœªè¾¾ä¸Šé™ï¼ˆä¾‹å¦‚ 10 æ¬¡ï¼‰ã€‚

2.  **å®šæ—¶æŠ•æ”¾ï¼ˆè¡¥å……ï¼‰**ï¼š
    *   åå°å®šæ—¶ä»»åŠ¡ï¼ˆCron Jobï¼‰ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆå¦‚ 10 åˆ†é’Ÿï¼‰ã€‚
    *   éšæœºé€‰å–è¿‘æœŸæ´»è·ƒç”¨æˆ·ï¼Œä¸»åŠ¨å‘é€é¢˜ç›®ï¼ˆç§èŠï¼‰ã€‚
    *   **é…ç½®é¡¹**ï¼šç®¡ç†å‘˜å¯è®¾ç½®æ¯å¤©è§¦å‘çš„æ—¶é—´æ®µï¼ˆå¦‚ 20:00-22:00ï¼‰ï¼Œä»¥åŠæŠ•æ”¾çš„äººæ•°é™åˆ¶ï¼ˆå¦‚éšæœºé€‰å– 50 äººæˆ–å…¨å‘˜æŠ•æ”¾ï¼‰ã€‚
    *   *é€‚ç”¨åœºæ™¯ï¼šç¾¤ç»„å†·åœºæ¿€æ´»ã€ç‰¹å®šæ—¶æ®µï¼ˆå¦‚æ·±å¤œï¼‰ç¦åˆ©ã€‚*

### 2.2 ç­”é¢˜æµç¨‹
1.  **é¢˜ç›®å‡ºç°**ï¼š
    *   **å›¾ç‰‡æ¨¡å¼**ï¼šç³»ç»Ÿæ£€æŸ¥ `quiz_images` è¡¨ï¼Œè‹¥é¢˜ç›®åŒ…å«çš„æ ‡ç­¾ï¼ˆå¦‚ "æ³°å‰§"ï¼‰æœ‰å¯¹åº”å›¾ç‰‡ï¼Œåˆ™éšæœºé€‰å–ä¸€å¼ å‘é€ï¼ˆé™„å¸¦é—®é¢˜å’Œé€‰é¡¹ï¼‰ã€‚
    *   **æ–‡æœ¬æ¨¡å¼**ï¼šè‹¥æ— å¯¹åº”å›¾ç‰‡ï¼Œåˆ™ç›´æ¥å‘é€æ–‡æœ¬æ¶ˆæ¯ã€‚
    
    æœºå™¨äººå›å¤ç”¨æˆ·ï¼ˆå¼•ç”¨ç”¨æˆ·æ¶ˆæ¯ï¼‰æˆ–ç›´æ¥å‘é€ï¼š
    > ğŸŒ¸ **æ¡œä¹‹é—®ç­” Â· çªè¢­ï¼**
    > â±ï¸ è¯·åœ¨ **10ç§’** å†…ä½œç­”
    >
    > [å›¾ç‰‡] (å¦‚æœæœ‰)
    >
    > **Qï¼šæ³°å‰§ã€Šä»¥ä½ çš„å¿ƒè¯ é‡Šæˆ‘çš„çˆ±ã€‹ä¸­ï¼Œå¾·å’Œæ¬§å„¿æ˜¯åœ¨å“ªé‡Œå’Œå¥½çš„ï¼Ÿ**
    >
    > A. æ™®å‰å²›çš„æ—¥è½è§’
    > B. æ›¼è°·çš„å…¬å¯“
    > C. ä¸­æ–‡è¡¥ä¹ ç­
    > D. è“¬è´´æµ·è§’

    *(é™„å¸¦ Inline Buttonsï¼Œä¸€è¡Œä¸¤ä¸ªæŒ‰é’®)*

2.  **ç”¨æˆ·ä½œç­”**ï¼š
    *   ç”¨æˆ·ç‚¹å‡»é€‰é¡¹æŒ‰é’®ã€‚
    *   **è¶…æ—¶åˆ¤å®š**ï¼šè‹¥è¶…è¿‡ 10 ç§’æœªä½œç­”ï¼Œé¢˜ç›®å¤±æ•ˆï¼ŒæŒ‰é’®å˜ç°æˆ–æç¤ºâ€œå·²è¶…æ—¶â€ã€‚

3.  **ç»“ç®—åé¦ˆ**ï¼š
    *   **ç­”å¯¹**ï¼š
        > â€œæ“ï¼ä½ ä¹Ÿå¤ªæ‡‚äº†å§ ğŸ˜³ğŸ”¥â€
        > ï¿½ **ç²¾ç²¹ +20** (å¥–åŠ± = åŸºç¡€ + æš´å‡»)
    *   **ç­”é”™**ï¼š
        > â€œå‘œå‘œï¼Œå·®ä¸€ç‚¹ï½é€ä½ ç‚¹å®‰æ…°ç²¾ç²¹ ğŸ’”â€
        > ğŸ **ç²¾ç²¹ +5** (åŸºç¡€ä½ä¿)

---

## 3. æ•°æ®åº“è®¾è®¡ (Schema)

åŸºäº `SQLAlchemy` æ¨¡å‹è®¾è®¡ã€‚

### 3.1 é¢˜åº“è¡¨ (`quiz_questions`)

å­˜å‚¨æ‰€æœ‰é—®ç­”é¢˜ç›®ã€‚

```python
class QuizQuestionModel(Base, BasicAuditMixin):
    __tablename__ = "quiz_questions"

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    
    # é¢˜ç›®å†…å®¹
    question: Mapped[str] = mapped_column(Text, nullable=False, comment="é¢˜ç›®æè¿°")
    
    # é€‰é¡¹ (JSONæ•°ç»„: ["é€‰é¡¹A", "é€‰é¡¹B", "é€‰é¡¹C", "é€‰é¡¹D"])
    options: Mapped[list[str]] = mapped_column(JSON, nullable=False, comment="é€‰é¡¹åˆ—è¡¨")
    
    # æ­£ç¡®ç­”æ¡ˆç´¢å¼• (0-3)
    correct_index: Mapped[int] = mapped_column(Integer, nullable=False, comment="æ­£ç¡®é€‰é¡¹çš„ç´¢å¼•")
    
    # éš¾åº¦ç³»æ•° (1-5)ï¼Œç”¨äºè®¡ç®—å¥–åŠ±åŠ æˆ
    difficulty: Mapped[int] = mapped_column(Integer, default=1, comment="éš¾åº¦ç­‰çº§")
    
    # å¥–åŠ±é…ç½®
    reward_base: Mapped[int] = mapped_column(Integer, default=5, comment="åŸºç¡€å¥–åŠ±(ç­”é”™/ä½ä¿)")
    reward_bonus: Mapped[int] = mapped_column(Integer, default=15, comment="é¢å¤–å¥–åŠ±(ç­”å¯¹)")
    
    # æ ‡ç­¾/åˆ†ç±» (å¦‚: "æ³°å‰§", "å°è¯", "CP")
    tags: Mapped[list[str] | None] = mapped_column(JSON, nullable=True, comment="æ ‡ç­¾")
    
    is_active: Mapped[bool] = mapped_column(default=True, comment="æ˜¯å¦å¯ç”¨")
    
    extra: Mapped[dict | None] = mapped_column(JSON, nullable=True, comment="æ‰©å±•æ•°æ®")
```

### 3.2 é—®ç­”å›¾ç‰‡è¡¨ (`quiz_images`)

ç”¨äºå­˜å‚¨é—®ç­”ç³»ç»Ÿçš„é…å›¾ï¼Œé€šè¿‡æ ‡ç­¾ä¸é¢˜ç›®å…³è”ã€‚

```python
class QuizImageModel(Base, BasicAuditMixin):
    __tablename__ = "quiz_images"

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    
    # å›¾ç‰‡æ–‡ä»¶ID (Telegram file_id)
    file_id: Mapped[str] = mapped_column(String(255), nullable=False, comment="Telegram File ID")
    file_unique_id: Mapped[str] = mapped_column(String(255), nullable=False, comment="Telegram File Unique ID")
    
    # æ ‡ç­¾/åˆ†ç±» (å¦‚: "æ³°å‰§", "CP") - ä¸é¢˜ç›®çš„tagsåŒ¹é…
    tags: Mapped[list[str]] = mapped_column(JSON, nullable=False, comment="å…³è”æ ‡ç­¾")
    
    description: Mapped[str | None] = mapped_column(Text, nullable=True, comment="å›¾ç‰‡æè¿°/å¤‡æ³¨")
    
    is_active: Mapped[bool] = mapped_column(default=True, comment="æ˜¯å¦å¯ç”¨")
    
    extra: Mapped[dict | None] = mapped_column(JSON, nullable=True, comment="æ‰©å±•æ•°æ®")
```

### 3.3 æ´»è·ƒé—®ç­”è¡¨ (`quiz_active_sessions`)

ç”¨äºçŠ¶æ€ç®¡ç†ã€é˜²åˆ·ã€è¶…æ—¶æ§åˆ¶ã€‚è®°å½•å½“å‰æ­£åœ¨è¿›è¡Œä¸­çš„ç­”é¢˜ä¼šè¯ã€‚

```python
class QuizActiveSessionModel(Base):
    __tablename__ = "quiz_active_sessions"

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    
    user_id: Mapped[int] = mapped_column(BigInteger, unique=True, index=True, comment="ç”¨æˆ·ID")
    chat_id: Mapped[int] = mapped_column(BigInteger, comment="è§¦å‘çš„èŠå¤©ID")
    message_id: Mapped[int] = mapped_column(BigInteger, comment="é¢˜ç›®æ¶ˆæ¯ID(ç”¨äºåæœŸç¼–è¾‘/åˆ é™¤)")
    
    question_id: Mapped[int] = mapped_column(Integer, comment="é¢˜ç›®ID")
    
    start_at: Mapped[datetime] = mapped_column(DateTime, default=now, comment="å¼€å§‹æ—¶é—´")
    expire_at: Mapped[datetime] = mapped_column(DateTime, comment="è¿‡æœŸæ—¶é—´(é€šå¸¸ä¸ºstart+10s)")
    
    extra: Mapped[dict | None] = mapped_column(JSON, nullable=True, comment="æ‰©å±•æ•°æ®")
```

### 3.4 ç­”é¢˜è®°å½•è¡¨ (`quiz_logs`)

ç”¨äºç»Ÿè®¡ã€åä½œå¼Šå’Œæˆå°±ç³»ç»Ÿã€‚

```python
class QuizLogModel(Base, TimestampMixin):
    __tablename__ = "quiz_logs"

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    
    user_id: Mapped[int] = mapped_column(BigInteger, index=True)
    question_id: Mapped[int] = mapped_column(Integer)
    
    # ç”¨æˆ·ç­”æ¡ˆ: 0-3ä¸ºé€‰é¡¹ç´¢å¼•, NULLä¸ºæœªä½œç­”/è¶…æ—¶
    user_answer: Mapped[int | None] = mapped_column(Integer, nullable=True, comment="ç”¨æˆ·é€‰æ‹©")
    
    # ç»“æœçŠ¶æ€: æ˜¯å¦æ­£ç¡® (è¶…æ—¶/æœªç­”ä¹Ÿç®—False)
    is_correct: Mapped[bool] = mapped_column(Boolean, default=False, comment="æ˜¯å¦ç­”å¯¹")
    
    reward_amount: Mapped[int] = mapped_column(Integer, comment="å®é™…è·å¾—çš„ç²¾ç²¹æ•°é‡")
    
    duration_ms: Mapped[int | None] = mapped_column(Integer, nullable=True, comment="ç­”é¢˜è€—æ—¶(æ¯«ç§’)")
    
    extra: Mapped[dict | None] = mapped_column(JSON, nullable=True, comment="æ‰©å±•æ•°æ®")
```

---

## 4. å…³é”®é€»è¾‘ä¸é…ç½®

### 4.1 ç§¯åˆ†ç³»ç»Ÿé›†æˆ
*   **å…³è”æ¨¡å‹**ï¼š`UserExtendModel` (ä½äº `bot/database/models/user_extend.py`)
*   **å­—æ®µ**ï¼š`currency_balance` (å½“å‰ä½™é¢), `currency_total` (å†å²æ€»é‡)
*   **æ“ä½œ**ï¼šç­”é¢˜ç»“ç®—æ—¶ï¼Œç›´æ¥æ›´æ–°ç”¨æˆ·çš„ `currency_balance` å¹¶è®°å½•æ—¥å¿—ã€‚

### 4.2 é…ç½®å‚æ•° (Config)

å»ºè®®å†™å…¥é…ç½®æ–‡ä»¶æˆ–æ•°æ®åº“é…ç½®è¡¨ï¼š

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- |
| `QUIZ_TRIGGER_RATE` | 0.03 (3%) | äº¤äº’è§¦å‘æ¦‚ç‡ |
| `QUIZ_TIMEOUT_SECONDS` | 10 | ç­”é¢˜é™æ—¶(ç§’) |
| `QUIZ_COOLDOWN_MINUTES` | 30 | å•ç”¨æˆ·è§¦å‘å†·å´æ—¶é—´(åˆ†é’Ÿ) |
| `QUIZ_DAILY_LIMIT` | 5 | å•ç”¨æˆ·æ¯æ—¥æœ€å¤§è§¦å‘æ¬¡æ•° |
| `QUIZ_REWARD_FAIL` | 1~3 | ç­”é”™å®‰æ…°å¥–èŒƒå›´ |
| `QUIZ_REWARD_SUCCESS` | 10~20 | ç­”å¯¹å¥–åŠ±èŒƒå›´ |

### 4.3 é˜²ä½œå¼Šä¸é£æ§
1.  **å”¯ä¸€æ€§æ£€æŸ¥**ï¼šæŸ¥è¯¢ `quiz_active_sessions`ï¼Œç¡®ä¿ç”¨æˆ·åŒä¸€æ—¶é—´åªæœ‰ä¸€é“é¢˜ã€‚
2.  **è¿‡æœŸæ¸…ç†**ï¼šåå°ä»»åŠ¡æˆ–è§¦å‘æ—¶æ£€æŸ¥ï¼Œæ¸…ç† `expire_at` å·²è¿‡æœŸçš„ä¼šè¯ã€‚
3.  **å¹¶å‘é”**ï¼šç­”é¢˜æ¥å£éœ€åŠ é”ï¼ˆæˆ–æ•°æ®åº“è¡Œé”ï¼‰ï¼Œé˜²æ­¢åˆ©ç”¨ç½‘ç»œå»¶è¿Ÿé‡å¤æäº¤ç­”æ¡ˆåˆ·åˆ†ã€‚

---

## 5. åç»­æ‰©å±•è§„åˆ’

1.  **è¿èƒœç³»ç»Ÿ (Streak)**ï¼šè¿ç»­ç­”å¯¹ N é¢˜ï¼Œå¥–åŠ±å€ç‡æå‡ã€‚
2.  **ç”¨æˆ·æŠ•ç¨¿**ï¼šå…è®¸ç”¨æˆ·æäº¤é¢˜ç›®ï¼Œç®¡ç†å‘˜å®¡æ ¸é€šè¿‡åç»™äºˆå¤§é¢ç²¾ç²¹å¥–åŠ±ã€‚
3.  **æ’è¡Œæ¦œ**ï¼šBL çŸ¥è¯†ç«èµ›å‘¨æ¦œ/æœˆæ¦œã€‚
4.  **ç§°å·ç³»ç»Ÿ**ï¼šç­”å¯¹ç‰¹å®šæ ‡ç­¾ï¼ˆå¦‚â€œæ³°å‰§â€ï¼‰é¢˜ç›®è¾¾åˆ°ä¸€å®šæ•°é‡ï¼Œè§£é”ç§°å·ï¼ˆå¦‚â€œæ³°è…åçº§å­¦è€…â€ï¼‰ã€‚

---

## 6. å¼€å‘ä»»åŠ¡æ¸…å•

- [ ] **Database**: åˆ›å»º `QuizQuestionModel`, `QuizImageModel`, `QuizActiveSessionModel`, `QuizLogModel`ã€‚
- [ ] **Admin**: å®ç°é¢˜åº“ç®¡ç†å‘½ä»¤ï¼ˆæ·»åŠ /ç¼–è¾‘/åˆ é™¤é¢˜ç›®ï¼‰ã€‚
- [ ] **Service**: 
    - å®ç° `QuizService.trigger_check(user_id)` (è§¦å‘åˆ¤å®š)ã€‚
    - å®ç° `QuizService.generate_quiz(user_id)` (å‡ºé¢˜)ã€‚
    - å®ç° `QuizService.submit_answer(user_id, answer_index)` (åˆ¤é¢˜ä¸ç»“ç®—)ã€‚
- [ ] **Handler**: ç›‘å¬ç”¨æˆ·äº¤äº’ï¼ˆMessage/Callbackï¼‰ï¼Œæ¥å…¥è§¦å‘æ£€æŸ¥é€»è¾‘ã€‚
- [ ] **Scheduler**: (å¯é€‰) å®ç°å®šæ—¶æŠ•æ”¾ä»»åŠ¡ã€‚
