# ğŸŒ¸ æ¡œè‰²ç”·å­© (LustfulBoy) - ç»æµç³»ç»Ÿè®¾è®¡

> **çŠ¶æ€**: ğŸ“ è®¾è®¡ä¸­
> **æ—¥æœŸ**: 2025-12-24
> **å®˜ç½‘**: lustfulboy.com
> **é€‚ç”¨**: Telegram Bot (Aiogram 3.x)
> **ä¸»é¢˜**: BL / Gay / Emby / ç¤¾äº¤

## 1. æ ¸å¿ƒæ¦‚å¿µ (Core Concepts)

é‡‡ç”¨ç§¯åˆ†åˆ¶æ¿€åŠ±ç”¨æˆ·æ´»è·ƒã€‚

*   **ä»£å¸åç§°**: **ç²¾ç²¹ (Essence)**
*   **ä»£å¸ç¬¦å·**: `ğŸ’§`
*   **æ ¸å¿ƒé€»è¾‘**: 
    *   ç”¨æˆ·é€šè¿‡æ´»è·ƒï¼ˆç­¾åˆ°ã€èŠå¤©ã€äº’åŠ¨ï¼‰è·å–ä»£å¸ã€‚
    *   ç§¯æ”’ç²¾ç²¹å¯ä»¥æ¢å– Emby è§‚å½±ç‰¹æƒæˆ–ç¾¤ç»„ç‰¹æ®Šèº«ä»½ã€‚

## 2. äº¤äº’ä½“éªŒè®¾è®¡ (UX Design)

âŒ **å¼ƒç”¨**: ä¼ ç»Ÿçš„ `/sign` å‘½ä»¤è¡Œäº¤äº’ã€‚
âœ… **é‡‡ç”¨**: å…¨ **UI/æŒ‰é’®** é©±åŠ¨ï¼Œæ— ç¼é›†æˆåœ¨ç”¨æˆ·é¢æ¿ä¸­ã€‚

### A. æ¯æ—¥ç­¾åˆ° (Daily Check-in)
*   **å…¥å£**: åœ¨ã€è´¦å·ä¸­å¿ƒã€‘é¢æ¿æ˜¾ç¤º `[ğŸ“… æ¯æ—¥ç­¾åˆ°]` æŒ‰é’®ã€‚
*   **çŠ¶æ€æ˜¾ç¤º**: 
    *   æœªç­¾åˆ°æ—¶ï¼šæŒ‰é’®äº®èµ·ï¼Œæ–‡æ¡ˆä¸º `ğŸ“… æ¯æ—¥ç­¾åˆ°`ã€‚
    *   å·²ç­¾åˆ°æ—¶ï¼šæŒ‰é’®å˜ç°æˆ–æ–‡æ¡ˆå˜ä¸º `âœ… ä»Šæ—¥å·²ç­¾`ï¼Œå¹¶åœ¨é¢æ¿ä¸‹æ–¹æ˜¾ç¤º `ğŸ’§ ç²¾ç²¹: 120`ã€‚
*   **äº¤äº’æµç¨‹**:
    1.  ç”¨æˆ·ç‚¹å‡» `[ğŸ“… æ¯æ—¥ç­¾åˆ°]`ã€‚
    2.  Bot å¼¹çª— (Alert) æç¤ºï¼š
        > "ç­¾åˆ°æˆåŠŸï¼
        > è·å¾—: +20 ğŸ’§
        > è¿ç»­: 3 å¤© (åŠ æˆ +10%)
        >
        > ğŸ’¬ ä»Šæ—¥è¿åŠ¿: å®œé¢åŸºï¼Œå¿Œç‹¬å®ˆç©ºæˆ¿ã€‚"
    3.  Bot **é™é»˜åˆ·æ–°** åŸæ¶ˆæ¯ï¼Œæ›´æ–°ä½™é¢æ˜¾ç¤ºï¼Œä¸å‘é€æ–°æ¶ˆæ¯åˆ·å±ã€‚

### B. ç²¾ç²¹å•†åº— (Essence Store)
*   **å…¥å£**: `[ğŸ›ï¸ ç²¾ç²¹å•†åº—]` æŒ‰é’®ã€‚
*   **ç•Œé¢**: ä½¿ç”¨å†…è”é”®ç›˜ç¿»é¡µå±•ç¤ºå¯å…‘æ¢å•†å“ã€‚
*   **å•†å“**:
    *   **Emby æ—¶é•¿**: 100 ğŸ’§ = 1å¤©è§‚çœ‹æƒã€‚
    *   **è¡¥ç­¾å¡**: 50 ğŸ’§ = æ¢å¤æ–­ç­¾ã€‚
    *   **ç‰¹æ®Šå¤´è¡”**: "ğŸŒ¸ æ¨±ä¹‹ä¸»" / "ğŸ¶ å¿ çŠ¬" (ç¾¤ç»„ Title)ã€‚

## 3. æ•°æ®åº“è®¾è®¡ (Schema Optimization)

ä½¿ç”¨é€šç”¨çš„å‘½åè§„èŒƒï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ã€‚æ‰€æœ‰è¡¨å‡åŒ…å«åŸºç¡€å®¡è®¡å­—æ®µ (`created_at`, `updated_at`, `is_deleted` ç­‰)ã€‚

### 1. `user_extend` (ç”¨æˆ·æ‰©å±•è¡¨)
å¤ç”¨å·²æœ‰çš„ `user_extend` è¡¨ï¼Œæ–°å¢ç»æµç³»ç»Ÿç›¸å…³å­—æ®µã€‚

| å­—æ®µå | ç±»å‹ | å±æ€§ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `user_id` | BigInt | PK, FK | å…³è” `users.id` |
| ... | ... | ... | (åŸæœ‰å­—æ®µ: role, emby_user_id, bio ç­‰) |
| `currency_balance` | Integer | Default 0 | å½“å‰ä»£å¸ä½™é¢ |
| `currency_total` | BigInt | Default 0 | å†å²ç´¯è®¡è·å–æ€»é‡ (ç”¨äºç­‰çº§/æˆå°±) |
| `streak_days` | Integer | Default 0 | å½“å‰è¿ç»­ç­¾åˆ°å¤©æ•° |
| `last_checkin_date` | Date | Nullable | ä¸Šæ¬¡ç­¾åˆ°æ—¥æœŸ (ç”¨äºè®¡ç®—æ–­ç­¾) |
| `created_at` | DateTime | Auto | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DateTime | Auto | æœ€åæ›´æ–°æ—¶é—´ |

### 2. `currency_transactions` (æµæ°´è¡¨)
ä¸å¯å˜æ—¥å¿—ï¼Œç”¨äºå®¡è®¡å’Œå›æº¯ã€‚

| å­—æ®µå | ç±»å‹ | å±æ€§ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `id` | BigInt | PK, Auto | æµæ°´ID |
| `user_id` | BigInt | FK, Index | å…³è” `users.id` |
| `amount` | Integer | Not Null | å˜åŠ¨æ•°å€¼ (æ­£æ•°ä¸ºè·å–ï¼Œè´Ÿæ•°ä¸ºæ¶ˆè€—) |
| `balance_after` | Integer | Not Null | **å˜åŠ¨åä½™é¢** (å¿«ç…§ï¼Œé˜²æ­¢è®¡ç®—è¯¯å·®) |
| `event_type` | Varchar(32)| Index | äº‹ä»¶ç±»å‹: `daily_checkin`, `redeem_emby` ç­‰ |
| `description` | Varchar(255) | Nullable | **æµæ°´æè¿°**: äººç±»å¯è¯»çš„è¯´æ˜ (å¦‚ "è´­ä¹° Emby 30å¤©") |
| `meta` | JSON | Nullable | æ‰©å±•ä¿¡æ¯ (å¦‚: `{"streak": 5, "product_id": 1}`) |
| `created_at` | DateTime | Auto | å‘ç”Ÿæ—¶é—´ |

## 4. åŠ¨æ€é…ç½®ä¸å•†å“ç³»ç»Ÿ (Dynamic Configuration & Products)

ä¸ºäº†æ”¯æŒç®¡ç†å‘˜åŠ¨æ€è°ƒæ•´æ•°å€¼å’Œç®¡ç†å•†å“ï¼Œæˆ‘ä»¬å°†è§„åˆ™ä¸å•†å“ä¿¡æ¯å­˜å…¥æ•°æ®åº“ã€‚

### 1. `currency_rules` (è§„åˆ™è¡¨)
å­˜å‚¨å„ç§è¡Œä¸ºçš„å¥–æƒ©æ•°å€¼ï¼Œæ”¯æŒåŠ¨æ€è°ƒæ•´ã€‚

| å­—æ®µå | ç±»å‹ | å±æ€§ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `id` | Integer | PK, Auto | è§„åˆ™ID |
| `rule_key` | Varchar(64) | Unique | è§„åˆ™é”®å (å¦‚ `checkin_base`, `checkin_bonus_rate`) |
| `value` | Integer | Not Null | æ•°å€¼ (å¦‚ 20, 10) |
| `description` | Varchar(255) | Nullable | è§„åˆ™è¯´æ˜ |
| `is_active` | Boolean | Default True | æ˜¯å¦å¯ç”¨ |
| `updated_at` | DateTime | Auto | æœ€åæ›´æ–°æ—¶é—´ |

**ç¤ºä¾‹æ•°æ®**:
*   `checkin_base`: 20 (ç­¾åˆ°åŸºç¡€å¥–åŠ±)
*   `checkin_streak_bonus`: 10 (è¿ç­¾æ¯æ—¥åŠ æˆ%)
*   `invite_bonus`: 50 (é‚€è¯·å¥–åŠ±)

### 2. `currency_products` (å•†å“è¡¨)
å­˜å‚¨å•†åº—å¯å”®å–çš„å•†å“ä¿¡æ¯ï¼Œæ”¯æŒä¸Šä¸‹æ¶ã€æœ‰æ•ˆæœŸç®¡ç†ä»¥åŠ**åŒé‡æƒé™æ§åˆ¶**ã€‚

| å­—æ®µå | ç±»å‹ | å±æ€§ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `id` | Integer | PK, Auto | å•†å“ID |
| `name` | Varchar(128) | Not Null | å•†å“åç§° (å¦‚ "Emby 1å¤©æƒé™") |
| `description` | Text | Nullable | å•†å“æè¿° |
| `price` | Integer | Not Null | ä»·æ ¼ (ä»£å¸) |
| `category` | Varchar(32) | Index | åˆ†ç±»: `emby_duration`, `item`, `title` |
| `reward_value` | JSON | Nullable | å®é™…æ•ˆæœå‚æ•° (å¦‚ `{"days": 1}`, `{"title": "ğŸŒ¸"}`) |
| `stock` | Integer | Default -1 | åº“å­˜ (-1è¡¨ç¤ºæ— é™) |
| `visible_conditions` | JSON | Nullable | **å¯è§æ¡ä»¶**: è°å¯ä»¥çœ‹åˆ°è¯¥å•†å“ (å¦‚ `{"has_emby": true}`) |
| `purchase_conditions`| JSON | Nullable | **è´­ä¹°æ¡ä»¶**: è°å¯ä»¥è´­ä¹°è¯¥å•†å“ (å¦‚ `{"min_days": 30}`) |
| `start_time` | DateTime | Nullable | ä¸Šæ¶æ—¶é—´ (ç©ºè¡¨ç¤ºç«‹å³) |
| `end_time` | DateTime | Nullable | ä¸‹æ¶æ—¶é—´ (ç©ºè¡¨ç¤ºæ°¸ä¹…) |
| `is_active` | Boolean | Default True | æ˜¯å¦ä¸Šæ¶ |
| `created_at` | DateTime | Auto | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DateTime | Auto | æœ€åæ›´æ–°æ—¶é—´ |

## 5. ç­¾åˆ°ç®—æ³• (Algorithm)

*   **åŸºç¡€å¥–åŠ±**: 10 ~ 20 ğŸ’§ (éšæœºæµ®åŠ¨ï¼Œå¢åŠ è¶£å‘³æ€§)ã€‚
*   **è¿ç­¾åŠ æˆ**: 
    *   `bonus = base * min(streak * 0.1, 1.0)`
    *   ä¸Šé™ä¸º 100% åŠ æˆ (å³è¿ç­¾10å¤©è¾¾åˆ°åŒå€)ã€‚
*   **æ–­ç­¾é€»è¾‘**: 
    *   è‹¥ `today - last_checkin_date > 1`ï¼Œåˆ™ `streak_days` é‡ç½®ä¸º 1ã€‚

## 5. å¼€å‘è®¡åˆ’ (Roadmap)

1.  **Phase 1**: åˆ›å»ºæ•°æ®åº“è¡¨ï¼Œå®ç° `EconomyService` (å¢åˆ æŸ¥æ”¹)ã€‚
2.  **Phase 2**: ä¿®æ”¹ `get_account_center_keyboard`ï¼ŒåŠ å…¥ç­¾åˆ°æŒ‰é’®ã€‚
3.  **Phase 3**: å®ç°ç­¾åˆ°å›è°ƒé€»è¾‘ (`checkin_callback`) ä¸å¼¹çª—åé¦ˆã€‚
4.  **Phase 4**: å¼€å‘å•†åº—ç•Œé¢ä¸å…‘æ¢é€»è¾‘ã€‚
