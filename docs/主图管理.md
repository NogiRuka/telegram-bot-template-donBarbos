现在需要开发一个管理员功能，🖼 主图管理，设置主消息对应的图片，这样用户开启新的消息时就是新的图片，有新鲜感。
管理员可以上传图片，看到图片列表，设置节日图片，用户在指定时间内开启消息时，就会显示设置的节日图片。图片分为 sfw（安全内容）和 nsfw（非安全内容）两个大类，用户默认展示的都是sfw的图片，另外nsfw和随机这两个展示类型用户可以设置，但是需要在精粹商店购买已解锁设置的权限（解锁🔞主图  价格60），管理员可以控制是否启用 nsfw 图片的展示。主图管理里再加一个图片测试，可以发送图片获取图片详细信息，这些信息都保存到数据库里，也可以管理员发送文件id,机器人发送对应信息及文件

在你实现功能之前，先做成一个文档记录数据库设计表结构怎么实现等等让我先review，这样有错误的地方可以及时更改。

# 主图管理设计文档

## 1. 功能概述
- 管理员在后台管理“主图池”，支持上传、查看、启用/禁用、删除。
- 支持“节日主图”定时投放：在指定时间窗内优先显示节日主图。
- 支持图片类型分组：SFW（安全）与 NSFW（非安全）；默认向用户展示 SFW。
- 用户可在设置中选择展示模式：sfw / nsfw / 随机；其中 nsfw 与随机需要在精粹商店购买解锁权限（商品：解锁🔞主图 价格60）。
- 管理员可全局关闭 NSFW 展示（即使用户已解锁，也不展示 NSFW）。
- 提供“图片测试”能力：管理员发送图片或文件ID，机器人返回图片元数据并可保存为主图条目。

## 2. 术语与行为
- 主图：用户打开主消息时展示的顶部图片。
- SFW/NSFW：内容安全分级，NSFW 显示需双重条件满足（用户已解锁 + 管理员全局启用）。
- 展示模式：
  - sfw：只从 SFW 池中选图
  - nsfw：只从 NSFW 池中选图（需解锁）
  - 随机：按用户设置与全局开关，从 SFW/NSFW 池中加权随机
- 节日图：在时间窗内优先展示的主图，支持优先级。

## 3. 数据库设计
> 所有模型继承 BasicAuditMixin，包含 created_at、updated_at、created_by、updated_by、is_deleted、deleted_at、deleted_by、remark。

### 3.1 main_images（主图库）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | Int, PK | 主键 |
| file_id | Varchar(256), Unique | Telegram 文件ID（稳定于同一机器人） |
| source_type | Varchar(16) | 来源类型：photo/document |
| mime_type | Varchar(64), Nullable | MIME 类型 |
| width | Int, Nullable | 宽像素 |
| height | Int, Nullable | 高像素 |
| file_size | Int, Nullable | 字节大小 |
| is_nsfw | Boolean, Default False | 是否 NSFW |
| is_enabled | Boolean, Default True | 是否参与投放 |
| caption | Text, Nullable | 原始说明文本（注意 MarkdownV2 转义） |
| hash | Varchar(64), Nullable | 文件哈希（避免重复） |
| tags | JSON, Nullable | 标签数组（如“节日/夏季”） |
| extra_data | JSON, Nullable | 扩展信息（示例：原消息ID、聊天ID） |

索引建议：
- idx_main_images_enabled_nsfw (is_enabled, is_nsfw)
- idx_main_images_hash (hash)

### 3.2 main_image_schedule（主图投放计划）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | Int, PK | 主键 |
| image_id | Int, FK -> main_images.id | 关联主图 |
| start_time | DateTime | 生效时间（含） |
| end_time | DateTime | 失效时间（含） |
| priority | Int, Default 100 | 优先级（数值越小越优先） |
| only_sfw | Boolean, Default True | 节日图仅用于 SFW 模式 |
| allow_nsfw | Boolean, Default False | 节日图允许用于 NSFW 模式 |
| label | Varchar(64), Nullable | 计划标签（如“中秋”） |
| extra_data | JSON, Nullable | 扩展信息 |

索引建议：
- idx_image_schedule_window (start_time, end_time)
- idx_image_schedule_priority (priority)

### 3.3 用户主图偏好（并入 user_extend）
为避免新增表，用户主图偏好字段直接并入现有 `user_extend`：
| 字段 | 类型 | 说明 |
|---|---|---|
| display_mode | Varchar(16) | 展示模式：sfw/nsfw/random（默认 sfw） |
| nsfw_unlocked | Boolean, Default False | 是否已通过商店解锁 NSFW 权限 |
| last_image_id | Int, Nullable | 最近一次展示的主图ID（用于避免短期重复） |
| extra_data | JSON, Nullable | 扩展信息（如频率限制快照） |

索引建议（如需）：
- idx_user_extend_main_image_nsfw (nsfw_unlocked)

## 4. 权限与开关
- 全局开关：在配置表中加入 `admin.main_image.nsfw_enabled`（Boolean），管理员面板可开关 NSFW。
- 用户解锁：商店商品“解锁🔞主图”购买后，写入 `user_extend.nsfw_unlocked = True`。
- 双重判定：仅当 `nsfw_unlocked == True` 且 `admin.main_image.nsfw_enabled == True` 时，用户可选择 NSFW 或随机包含 NSFW。

## 5. 精粹商店对接
- 新增商品：
  - name: 解锁🔞主图
  - price: 60
  - category: tools
  - action_type: main_image_unlock_nsfw
  - stock: 20
  - description: 解锁主图的 NSFW/随机展示模式设置权限
- 购买效果：
  - 在 `CurrencyService._handle_product_effect` 中对 `action_type == "main_image_unlock_nsfw"`：
    - 更新 `user_extend.nsfw_unlocked = True`（幂等，如不存在则创建扩展记录）。
    - 返回提示“已解锁主图 NSFW/随机模式设置”。
- 购买记录：
  - `currency_transactions` 记录 event_type = "purchase"，meta 含 product_id、action_type。
  - 此商品为“非消耗型资格”，`is_consumed=True`（仅记账，不做券管理）。

## 6. 投放与选择算法
- 优先选择节日图：在当前时间范围内，按 priority 最小的计划选择其 image。
- 若无节日图：
  - 根据用户展示模式与全局开关，筛选图片池（SFW/NSFW）。
  - 随机选择图片（可选按权重：近期未展示、尺寸大优先、带标签优先）。
  - 可选：避免短期重复（比较 `last_image_id`，必要时重试）。
- 记录结果：更新 `user_extend.last_image_id`。

## 7. 管理员工作流
- 上传图片：
  - 管理员发送图片或文件ID，机器人使用 Telegram API 获取 `file_id` 与图片元数据（宽、高、大小、MIME）。
  - 保存为 `main_images` 条目，默认 `is_enabled=True`，`is_nsfw=False`。
- 列表/启停：
  - 支持分页查看，按 `is_enabled/is_nsfw` 过滤。
  - 切换 `is_enabled`、修改 `is_nsfw`。
- 节日计划：
  - 选择图片并设置时间窗与优先级，可设置 `only_sfw/allow_nsfw`。
- 图片测试：
  - 管理员发送图片或文件ID，机器人返回详细信息并可选择“保存到主图库”或“附加到节日计划”。

## 8. Telegram API 限制与说明
- 消息长度：文本上限 4096 字符；Caption 上限约 1024 字符。
- 速率限制：建议对管理操作添加节流，避免频繁调用造成 `429 Too Many Requests`。
- 文件ID：只在同一机器人内稳定；建议保存原始消息的 chat_id、message_id 以便追溯。
- MarkdownV2：展示文本需转义特殊字符（如 `_ * [ ] ( ) ~ > # + - = | { } . !`）。

## 9. 异步/错误处理规范
- 所有处理器与服务函数使用 `async def`，数据库访问使用 `AsyncSession`。
- 外部调用（Telegram API/下载文件）添加 `try/except` 并记录异常，提示“操作失败请稍后重试”。
- 对管理员输入的 file_id 进行格式校验与存在性校验（例如尝试获取 `file_info`）。
- 重要变更（启停、NSFW 开关、节日计划）写审计 `remark`。

## 10. 开发计划（实施步骤）
1. 建表：`main_images`、`main_image_schedule`；扩展 `user_extend` 添加用户主图偏好字段。
2. 管理面板：主图列表/上传/启停、节日计划管理、图片测试工具。
3. 商店商品：`main_image_unlock_nsfw` 接入购买流程与效果。
4. 用户设置：展示模式选择（默认 sfw），检查解锁与全局开关。
5. 投放逻辑：在用户打开主消息时按算法选择图片。
6. 审计与日志：关键操作写 `remark` 与流水，异常告警。

## 11. 依赖说明（安装）
- Aiogram 3.x：`pip install aiogram`
- SQLAlchemy（异步，MySQL 驱动示例使用 aiomysql）：`pip install sqlalchemy aiomysql`
- Loguru：`pip install loguru`
- MySQL 连接（Windows 兼容，推荐使用 aiomysql 或 PyMySQL）：`pip install aiomysql` 或 `pip install pymysql`

示例 DSN（AsyncEngine）：
- `mysql+aiomysql://user:password@localhost:3306/dbname?charset=utf8mb4`
Windows 使用注意：
- 若遇到编译型驱动问题，优先选择纯 Python 的 `aiomysql`/`pymysql` 以保证安装兼容性。

## 12. 命名与风格
- 统一使用 snake_case 命名。
- 服务函数添加函数级注释（功能说明、输入参数、返回值）。
- 对外暴露的接口明确异步/同步用法；避免混用。
